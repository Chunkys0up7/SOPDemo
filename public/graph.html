<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' fonts.googleapis.com; font-src 'self' fonts.gstatic.com; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net unpkg.com; img-src 'self' data:;">
    <title>Interactive Dependency Graph - Pursuit Bank SOP Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/public/assets/css/common.css">
    <link rel="stylesheet" href="/public/assets/css/graph-page.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
</head>
<body>
    <!-- Include Global Navigation -->
    <div id="global-nav-container"></div>

    <!-- Page-specific inline styles migrated to /public/assets/css/graph-page.css -->
    <!-- Hero -->
    <section class="hero">
        <h1>SOP Dependency Graph</h1>
        <p>Visualize how your procedures connect. Click nodes to explore dependencies and understand the impact of changes across your documentation.</p>
    </section>

    <!-- Graph Wrapper -->
    <div class="graph-wrapper">
        <!-- Cytoscape Graph -->
        <div id="cy"></div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Graph Controls</h2>
                <p>Explore connections and dependencies</p>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="control-group">
                    <label class="control-label">Layout</label>
                    <div class="control-buttons">
                        <button class="control-btn active" data-layout="breadthfirst">Hierarchical</button>
                        <button class="control-btn" data-layout="cose">Organic</button>
                        <button class="control-btn" data-layout="circle">Circle</button>
                        <button class="control-btn" data-layout="grid">Grid</button>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">Filter by Type</label>
                    <div class="control-buttons">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="sop">SOPs</button>
                        <button class="filter-btn" data-filter="requirement">Requirements</button>
                        <button class="filter-btn" data-filter="atom">Atoms</button>
                        <button class="filter-btn" data-filter="molecule">Molecules</button>
                        <button class="filter-btn" data-filter="organism">Organisms</button>
                    </div>
                </div>
            </div>

            <!-- Sidebar Content -->
            <div class="sidebar-content">
                <!-- Stats -->
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-value" id="stat-nodes">0</div>
                        <div class="stat-label">NODES</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="stat-edges">0</div>
                        <div class="stat-label">EDGES</div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="legend">
                    <div class="legend-title">NODE TYPES</div>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-color sop"></div>
                            <span>SOP (Procedure)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color requirement"></div>
                            <span>Compliance Requirement</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color organism"></div>
                            <span>Complex Workflow</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color molecule"></div>
                            <span>Multi-Step Process</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color atom"></div>
                            <span>Basic Component</span>
                        </div>
                    </div>
                </div>

                <!-- AI Query Panel -->
                <div class="inl-5665ce37">
                    <div class="inl-dc6db445">
                        ü§ñ AI-Powered Insights
                    </div>
                    <div class="inl-355eeddb">
                        <button class="control-btn inl-afc36e7e" onclick="runAIQuery('attention')" >
                            üìã What Needs Attention?
                        </button>
                        <button class="control-btn inl-afc36e7e" onclick="runAIQuery('similar')" >
                            üîç Find Similar SOPs
                        </button>
                        <button class="control-btn inl-afc36e7e" onclick="runAIQuery('compliance')" >
                            ‚ö†Ô∏è Compliance Gaps
                        </button>
                        <button class="control-btn inl-afc36e7e" onclick="runAIQuery('impact')" >
                            üí• Impact Analysis
                        </button>
                    </div>
                </div>

                <!-- AI Results Display -->
                <div id="ai-results" class="inl-b3f95883">
                    <div class="inl-58ce971b">
                        <h3 class="inl-649e7776">AI Analysis</h3>
                        <button onclick="closeAIResults()" class="inl-8c206c1e">&times;</button>
                    </div>
                    <div id="ai-results-content" class="inl-90e2b698"></div>
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="empty-state">
                    <div class="empty-state-icon">üëÜ</div>
                    <div class="empty-state-text">Click on a node to see details</div>
                </div>

                <!-- Node Details -->
                <div class="node-details" id="node-details">
                    <div class="node-title" id="detail-title"></div>
                    <div class="node-meta" id="detail-meta"></div>

                    <div class="section inl-f2892a2e" id="dependencies-section" >
                        <div class="section-title">Dependencies</div>
                        <div class="dependency-list" id="dependencies-list"></div>
                    </div>

                    <div class="section inl-f2892a2e" id="dependents-section" >
                        <div class="section-title">Dependent SOPs</div>
                        <div class="dependency-list" id="dependents-list"></div>
                    </div>

                    <div class="section inl-f2892a2e" id="components-section" >
                        <div class="section-title">Components</div>
                        <div class="dependency-list" id="components-list"></div>
                    </div>

                    <div class="section" id="impact-section">
                        <div class="section-title">Impact Analysis</div>
                        <div id="impact-analysis"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cy;
        let graphData;
        let currentFilter = 'all';
        let graphLoaded = false;

        // Lazy load graph data when container is visible
        function loadGraphData() {
            if (graphLoaded) return;
            graphLoaded = true;

            console.log('üìä Loading graph data...');
            const graphContainer = document.getElementById('cy');

            // Show loading state
            graphContainer.innerHTML = `
                <div class="inl-d69565a3">
                    <div class="inl-d39bd7d1"></div>
                    <p>Loading graph visualization...</p>
                </div>
            `;

            // Fetch graph data
            fetch('/graph/sop-graph.json')
                .then(response => {
                    if (!response.ok) {
                        // Try relative path if absolute fails
                        return fetch('../graph/sop-graph.json');
                    }
                    return response;
                })
                .then(response => response.json())
                .then(data => {
                    console.log('‚úÖ Graph data loaded');
                    console.log('Nodes format:', Array.isArray(data.nodes) ? 'array' : 'object');
                    console.log('Total nodes:', Array.isArray(data.nodes) ? data.nodes.length : Object.keys(data.nodes).length);

                    // Ensure nodes is in object format for Cytoscape
                    // (initializeGraph uses Object.values which needs object, not array)
                    if (Array.isArray(data.nodes)) {
                        console.log('Converting nodes from array to object format');
                        const nodesObj = {};
                        data.nodes.forEach(node => {
                            nodesObj[node.id] = node;
                        });
                        data.nodes = nodesObj;
                    }

                    graphData = data;
                    initializeGraph(data);
                })
                .catch(error => {
                    console.error('‚ùå Error loading graph data:', error);
                    graphContainer.innerHTML = `
                        <div class="inl-34cdfd34">
                            <div class="inl-255a912b">‚ö†Ô∏è</div>
                            <h3 class="inl-e5e5f9a1">Failed to Load Graph</h3>
                            <p class="inl-b75fad00">Unable to load graph data. Please try again.</p>
                            <button onclick="location.reload()" class="inl-0d3a7063">
                                Retry
                            </button>
                        </div>
                    `;
                });
        }

        // Intersection Observer for lazy loading
        const graphContainer = document.getElementById('cy');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    loadGraphData();
                    observer.disconnect(); // Load only once
                }
            });
        }, { threshold: 0.1 });

        observer.observe(graphContainer);

        // Also load after 2 seconds if user is still on page
        setTimeout(() => {
            if (!graphLoaded) {
                console.log('‚è±Ô∏è  Auto-loading graph after delay...');
                loadGraphData();
            }
        }, 2000);

        function initializeGraph(data) {
            // Convert graph data to Cytoscape format
            const elements = [];

            // Add nodes
            Object.values(data.nodes).forEach(node => {
                elements.push({
                    data: {
                        id: node.id,
                        label: node.title,
                        type: node.type,
                        ...node
                    }
                });
            });

            // Add edges
            data.edges.forEach(edge => {
                elements.push({
                    data: {
                        id: edge.id,
                        source: edge.source,
                        target: edge.target,
                        type: edge.type,
                        description: edge.description,
                        strength: edge.strength
                    }
                });
            });

            // Color mapping for node types
            const colorMap = {
                'sop': '#0052CC',
                'atom': '#4caf50',
                'molecule': '#ff9800',
                'organism': '#9c27b0',
                'requirement': '#2196F3'  // Blue for compliance requirements
            };

            // Initialize Cytoscape
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': function(ele) {
                                return colorMap[ele.data('type')] || '#999';
                            },
                            'label': function(ele) {
                                // Show full label, let it wrap naturally
                                return ele.data('label');
                            },
                            'color': '#fff',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '11px',
                            'font-weight': '600',
                            'width': function(ele) {
                                // Larger nodes for better text display
                                return ele.data('type') === 'sop' ? 90 : 70;
                            },
                            'height': function(ele) {
                                return ele.data('type') === 'sop' ? 90 : 70;
                            },
                            'text-wrap': 'wrap',
                            'text-max-width': function(ele) {
                                return ele.data('type') === 'sop' ? '85px' : '65px';
                            },
                            'border-width': 3,
                            'border-color': '#fff',
                            'padding': '8px'
                        }
                    },
                    {
                        selector: 'node:selected',
                        style: {
                            'border-color': '#FFD700',
                            'border-width': 4
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': function(ele) {
                                const strength = ele.data('strength');
                                if (strength === 'strong') return 3;
                                if (strength === 'normal') return 2;
                                return 1;
                            },
                            'line-color': function(ele) {
                                const type = ele.data('type');
                                if (type === 'depends-on') return '#e53935';
                                if (type === 'component-of') return '#43a047';
                                return '#999';
                            },
                            'target-arrow-color': function(ele) {
                                const type = ele.data('type');
                                if (type === 'depends-on') return '#e53935';
                                if (type === 'component-of') return '#43a047';
                                return '#999';
                            },
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'opacity': 0.7
                        }
                    },
                    {
                        selector: 'edge:selected',
                        style: {
                            'line-color': '#FFD700',
                            'target-arrow-color': '#FFD700',
                            'opacity': 1
                        }
                    },
                    {
                        selector: '.highlighted',
                        style: {
                            'border-color': '#FFD700',
                            'border-width': 4
                        }
                    },
                    {
                        selector: '.dimmed',
                        style: {
                            'opacity': 0.3
                        }
                    }
                ],
                layout: {
                    name: 'breadthfirst',
                    directed: true,
                    spacingFactor: 1.5,
                    fit: true,
                    padding: 50,
                    avoidOverlap: true
                }
            });

            // Update stats
            updateStats();

            // Node click handler
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                showNodeDetails(node);
                highlightConnections(node);
            });

            // Background click handler
            cy.on('tap', function(evt) {
                if (evt.target === cy) {
                    hideNodeDetails();
                    clearHighlights();
                }
            });
        }

        function updateStats() {
            const nodeCount = cy.nodes().length;
            const edgeCount = cy.edges().length;
            document.getElementById('stat-nodes').textContent = nodeCount;
            document.getElementById('stat-edges').textContent = edgeCount;
        }

        function showNodeDetails(node) {
            const data = node.data();

            // Hide empty state
            document.getElementById('empty-state').style.display = 'none';

            // Show details
            const detailsEl = document.getElementById('node-details');
            detailsEl.classList.add('visible');

            // Title
            document.getElementById('detail-title').textContent = data.title || data.label;

            // Meta information
            const metaEl = document.getElementById('detail-meta');
            let metaHTML = '';

            metaHTML += `<div class="meta-item"><span class="meta-label">Type:</span><span class="badge badge-${data.type}">${data.type.toUpperCase()}</span></div>`;

            if (data.version) {
                metaHTML += `<div class="meta-item"><span class="meta-label">Version:</span><span class="meta-value">${data.version}</span></div>`;
            }

            if (data.status) {
                metaHTML += `<div class="meta-item"><span class="meta-label">Status:</span><span class="badge badge-${data.status}">${data.status}</span></div>`;
            }

            if (data.owner) {
                metaHTML += `<div class="meta-item"><span class="meta-label">Owner:</span><span class="meta-value">${data.owner}</span></div>`;
            }

            metaEl.innerHTML = metaHTML;

            // Dependencies (incoming edges with type 'depends-on')
            const dependencies = cy.edges(`[target = "${data.id}"][type = "depends-on"]`);
            const depsSection = document.getElementById('dependencies-section');
            const depsList = document.getElementById('dependencies-list');

            if (dependencies.length > 0) {
                depsSection.style.display = 'block';
                let depsHTML = '';
                dependencies.forEach(edge => {
                    const sourceNode = edge.source();
                    const strength = edge.data('strength') || 'normal';
                    const impactClass = strength === 'strong' ? 'impact-high' : (strength === 'normal' ? 'impact-normal' : 'impact-low');

                    depsHTML += `
                        <div class="dependency-item">
                            <div class="dependency-title">
                                ${sourceNode.data('title')}
                                <span class="impact-badge ${impactClass}">${strength}</span>
                            </div>
                            <div class="dependency-desc">${edge.data('description')}</div>
                        </div>
                    `;
                });
                depsList.innerHTML = depsHTML;
            } else {
                depsSection.style.display = 'none';
            }

            // Dependents (outgoing edges with type 'depends-on')
            const dependents = cy.edges(`[source = "${data.id}"][type = "depends-on"]`);
            const depsentsSection = document.getElementById('dependents-section');
            const depsentsList = document.getElementById('dependents-list');

            if (dependents.length > 0) {
                depsentsSection.style.display = 'block';
                let depsentsHTML = '';
                dependents.forEach(edge => {
                    const targetNode = edge.target();
                    const strength = edge.data('strength') || 'normal';
                    const impactClass = strength === 'strong' ? 'impact-high' : (strength === 'normal' ? 'impact-normal' : 'impact-low');

                    depsentsHTML += `
                        <div class="dependency-item">
                            <div class="dependency-title">
                                ${targetNode.data('title')}
                                <span class="impact-badge ${impactClass}">${strength}</span>
                            </div>
                            <div class="dependency-desc">${edge.data('description')}</div>
                        </div>
                    `;
                });
                depsentsList.innerHTML = depsentsHTML;
            } else {
                depsentsSection.style.display = 'none';
            }

            // Components (for organisms and molecules)
            if (data.components && data.components.length > 0) {
                const componentsSection = document.getElementById('components-section');
                const componentsList = document.getElementById('components-list');
                componentsSection.style.display = 'block';

                let componentsHTML = '';
                data.components.forEach(componentId => {
                    const componentNode = cy.getElementById(componentId);
                    if (componentNode.length > 0) {
                        componentsHTML += `
                            <div class="dependency-item">
                                <div class="dependency-title">${componentNode.data('title')}</div>
                                <div class="dependency-desc">Type: ${componentNode.data('type')}</div>
                            </div>
                        `;
                    }
                });
                componentsList.innerHTML = componentsHTML;
            } else {
                document.getElementById('components-section').style.display = 'none';
            }

            // Impact Analysis
            const impactEl = document.getElementById('impact-analysis');
            const allDependents = node.successors('node');
            const impactCount = allDependents.length;

            let impactHTML = `
                <div class="dependency-item">
                    <div class="dependency-title">Impact Scope: ${impactCount} nodes</div>
                    <div class="dependency-desc">
                        Changing this ${data.type} will affect ${impactCount} connected component${impactCount !== 1 ? 's' : ''}.
                    </div>
                </div>
            `;
            impactEl.innerHTML = impactHTML;
        }

        function hideNodeDetails() {
            document.getElementById('empty-state').style.display = 'block';
            document.getElementById('node-details').classList.remove('visible');
        }

        function highlightConnections(node) {
            // Dim all nodes and edges
            cy.elements().addClass('dimmed');

            // Highlight selected node
            node.removeClass('dimmed');
            node.addClass('highlighted');

            // Highlight connected nodes and edges
            const connectedEdges = node.connectedEdges();
            const connectedNodes = node.neighborhood('node');

            connectedEdges.removeClass('dimmed');
            connectedNodes.removeClass('dimmed');
        }

        function clearHighlights() {
            cy.elements().removeClass('dimmed highlighted');
        }

        // Layout controls
        document.querySelectorAll('[data-layout]').forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active state
                document.querySelectorAll('[data-layout]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Apply layout with optimized settings
                const layoutName = this.getAttribute('data-layout');
                let layoutOptions = {
                    name: layoutName,
                    fit: true,
                    padding: 50,
                    animate: true,
                    animationDuration: 500
                };

                // Specific settings for each layout
                if (layoutName === 'breadthfirst') {
                    layoutOptions.directed = true;
                    layoutOptions.spacingFactor = 1.5;
                    layoutOptions.avoidOverlap = true;
                } else if (layoutName === 'cose') {
                    layoutOptions.idealEdgeLength = 120;
                    layoutOptions.nodeOverlap = 40;
                    layoutOptions.nodeRepulsion = 500000;
                } else if (layoutName === 'circle') {
                    layoutOptions.spacingFactor = 1.2;
                } else if (layoutName === 'grid') {
                    layoutOptions.spacingFactor = 1.5;
                }

                const layout = cy.layout(layoutOptions);
                layout.run();
            });
        });

        // ============================================================================
        // AI Query Functions
        // ============================================================================

        function runAIQuery(queryType) {
            let results = '';

            switch(queryType) {
                case 'attention':
                    results = analyzeAttentionNeeded();
                    break;
                case 'similar':
                    results = findSimilarSOPs();
                    break;
                case 'compliance':
                    results = analyzeComplianceGaps();
                    break;
                case 'impact':
                    results = analyzeImpact();
                    break;
            }

            // Show results
            document.getElementById('ai-results').style.display = 'block';
            document.getElementById('ai-results-content').innerHTML = results;
        }

        function closeAIResults() {
            document.getElementById('ai-results').style.display = 'none';
        }

        function analyzeAttentionNeeded() {
            const today = new Date();
            const sops = Object.values(graphData.nodes).filter(n => n.type === 'sop');

            // Find SOPs needing review
            const needsReview = sops.filter(sop => {
                if (!sop.lastReviewed || !sop.reviewFrequency) return false;
                const lastReview = new Date(sop.lastReviewed);
                const daysSince = Math.floor((today - lastReview) / (1000 * 60 * 60 * 24));

                // Calculate review threshold
                const thresholds = { 'quarterly': 90, 'monthly': 30, 'annual': 365, 'biannual': 180 };
                const threshold = thresholds[sop.reviewFrequency] || 90;

                return daysSince >= threshold - 30; // Due within 30 days
            });

            // Find high criticality SOPs
            const highCriticality = sops.filter(s => s.criticality === 'high');

            // Find draft SOPs
            const drafts = sops.filter(s => s.status === 'draft');

            let html = '<div class="inl-51ca02c3">';
            html += '<h4 class="inl-6334446d">üìä Overview</h4>';
            html += `<p><strong>Total SOPs:</strong> ${sops.length}</p>`;
            html += `<p><strong>High Criticality:</strong> ${highCriticality.length}</p>`;
            html += `<p><strong>Draft Status:</strong> ${drafts.length}</p>`;

            html += '<h4 class="inl-7d572ad1">‚ö†Ô∏è Needs Attention</h4>';
            if (needsReview.length > 0) {
                html += '<p><strong>Due for Review:</strong></p><ul class="inl-d0a998b9">';
                needsReview.forEach(sop => {
                    const lastReview = new Date(sop.lastReviewed);
                    html += `<li><strong>${sop.title}</strong><br/>`;
                    html += `<span class="inl-ccdca83d">Owner: ${sop.owner} | Last: ${lastReview.toLocaleDateString()} | Freq: ${sop.reviewFrequency}</span></li>`;
                });
                html += '</ul>';
            } else {
                html += '<p class="inl-0cb99e9c">‚úì All SOPs are up to date with reviews</p>';
            }

            if (drafts.length > 0) {
                html += '<p class="inl-9c9cee20"><strong>Draft SOPs needing approval:</strong></p><ul class="inl-d0a998b9">';
                drafts.forEach(sop => {
                    html += `<li><strong>${sop.title}</strong> (${sop.owner})</li>`;
                });
                html += '</ul>';
            }

            html += '</div>';
            return html;
        }

        function findSimilarSOPs() {
            // Simple similarity based on shared compliance frameworks and keywords
            const sops = Object.values(graphData.nodes).filter(n => n.type === 'sop');
            const similarities = [];

            for (let i = 0; i < sops.length; i++) {
                for (let j = i + 1; j < sops.length; j++) {
                    const sop1 = sops[i];
                    const sop2 = sops[j];

                    // Calculate similarity score
                    const sharedFrameworks = (sop1.complianceFrameworks || []).filter(f =>
                        (sop2.complianceFrameworks || []).includes(f)
                    );
                    const sharedTags = (sop1.tags || []).filter(t =>
                        (sop2.tags || []).includes(t)
                    );
                    const sameDepartment = sop1.department === sop2.department;

                    const score = (sharedFrameworks.length * 20) + (sharedTags.length * 10) + (sameDepartment ? 15 : 0);

                    if (score >= 30) {
                        similarities.push({
                            sop1: sop1.title,
                            sop2: sop2.title,
                            score,
                            sharedFrameworks,
                            sharedTags
                        });
                    }
                }
            }

            similarities.sort((a, b) => b.score - a.score);

            let html = '<div class="inl-51ca02c3">';
            html += '<h4 class="inl-6334446d">üîç Similar SOPs Detected</h4>';

            if (similarities.length > 0) {
                html += '<p>These SOPs share significant overlap and may benefit from consolidation:</p>';
                html += '<ul class="inl-98c35876">';
                similarities.slice(0, 5).forEach(sim => {
                    html += `<li class="inl-72d6c38e"><strong>${sim.sop1}</strong> ‚Üî <strong>${sim.sop2}</strong><br/>`;
                    html += `<span class="inl-ccdca83d">Similarity: ${sim.score}% | `;
                    if (sim.sharedFrameworks.length > 0) {
                        html += `Shared frameworks: ${sim.sharedFrameworks.length} | `;
                    }
                    if (sim.sharedTags.length > 0) {
                        html += `Shared tags: ${sim.sharedTags.length}`;
                    }
                    html += '</span></li>';
                });
                html += '</ul>';
                html += '<p class="inl-1dd85d4c">';
                html += 'üí° <strong>Recommendation:</strong> Review these pairs for potential consolidation to reduce maintenance burden and ensure consistency.';
                html += '</p>';
            } else {
                html += '<p class="inl-0cb99e9c">‚úì No significant overlaps detected. SOPs appear well-differentiated.</p>';
            }

            html += '</div>';
            return html;
        }

        function analyzeComplianceGaps() {
            const requirements = Object.values(graphData.nodes).filter(n => n.type === 'requirement');
            const sops = Object.values(graphData.nodes).filter(n => n.type === 'sop');
            const implementsEdges = graphData.edges.filter(e => e.type === 'implements');

            // Count SOPs per requirement
            const coverage = {};
            requirements.forEach(req => {
                const implementers = implementsEdges.filter(e => e.target === req.id);
                coverage[req.id] = {
                    title: req.title || req.framework,
                    count: implementers.length,
                    implementers: implementers.map(e => {
                        const sop = sops.find(s => s.id === e.source);
                        return sop ? sop.title : e.source;
                    })
                };
            });

            const gaps = Object.values(coverage).filter(c => c.count < 2);
            const good = Object.values(coverage).filter(c => c.count >= 3);

            let html = '<div class="inl-51ca02c3">';
            html += '<h4 class="inl-6334446d">üìã Compliance Coverage Analysis</h4>';

            html += `<p><strong>Total Frameworks:</strong> ${requirements.length}</p>`;
            html += `<p><strong>Well Covered (3+ SOPs):</strong> ${good.length}</p>`;
            html += `<p><strong>Gaps (< 2 SOPs):</strong> ${gaps.length}</p>`;

            if (gaps.length > 0) {
                html += '<h4 class="inl-ed5164e2">üî¥ Critical Gaps</h4>';
                html += '<ul class="inl-d0a998b9">';
                gaps.forEach(gap => {
                    const status = gap.count === 0 ? '‚ùå No coverage' : '‚ö†Ô∏è Minimal coverage';
                    html += `<li><strong>${gap.title}</strong> - ${status}<br/>`;
                    if (gap.count > 0) {
                        html += `<span class="inl-ccdca83d">Implemented by: ${gap.implementers.join(', ')}</span>`;
                    }
                    html += '</li>';
                });
                html += '</ul>';

                html += '<p class="inl-c413a8eb">';
                html += '‚ö†Ô∏è <strong>Action Required:</strong> These frameworks require additional SOP coverage to ensure regulatory compliance.';
                html += '</p>';
            } else {
                html += '<p class="inl-94a69854">‚úì Excellent coverage! All frameworks are adequately documented.</p>';
            }

            html += '</div>';
            return html;
        }

        function analyzeImpact() {
            const sops = Object.values(graphData.nodes).filter(n => n.type === 'sop');
            const depends = graphData.edges.filter(e => e.type === 'depends-on');

            // Calculate impact scores
            const impacts = sops.map(sop => {
                const dependents = depends.filter(e => e.target === sop.id);
                const dependencies = depends.filter(e => e.source === sop.id);

                return {
                    id: sop.id,
                    title: sop.title,
                    owner: sop.owner,
                    criticality: sop.criticality,
                    dependentCount: dependents.length,
                    dependencyCount: dependencies.length,
                    impactScore: (dependents.length * 10) + (sop.criticality === 'high' ? 20 : 0)
                };
            }).sort((a, b) => b.impactScore - a.impactScore);

            const highImpact = impacts.filter(i => i.impactScore >= 20);

            let html = '<div class="inl-51ca02c3">';
            html += '<h4 class="inl-6334446d">üí• Impact Analysis</h4>';
            html += '<p>SOPs ranked by potential impact of changes:</p>';

            html += '<h4 class="inl-7d572ad1">üî• High Impact SOPs</h4>';
            if (highImpact.length > 0) {
                html += '<ul class="inl-d0a998b9">';
                highImpact.slice(0, 5).forEach(item => {
                    html += `<li class="inl-2d98adf5"><strong>${item.title}</strong><br/>`;
                    html += `<span class="inl-ccdca83d">`;
                    html += `Impact Score: ${item.impactScore} | `;
                    html += `Dependents: ${item.dependentCount} SOPs | `;
                    html += `Dependencies: ${item.dependencyCount} | `;
                    html += `Owner: ${item.owner} | `;
                    html += `Criticality: ${item.criticality}`;
                    html += '</span></li>';
                });
                html += '</ul>';

                html += '<p class="inl-1dd85d4c">';
                html += '‚ö†Ô∏è <strong>Warning:</strong> Changes to these SOPs will have cascading effects. ';
                html += 'Notify dependent SOP owners and allow extra review time.';
                html += '</p>';
            } else {
                html += '<p>No high-impact SOPs detected.</p>';
            }

            html += '</div>';
            return html;
        }

        // Filter controls
        document.querySelectorAll('[data-filter]').forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active state
                document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Apply filter
                const filterType = this.getAttribute('data-filter');
                currentFilter = filterType;

                if (filterType === 'all') {
                    cy.nodes().style('display', 'element');
                    cy.edges().style('display', 'element');
                } else {
                    // Hide all nodes first
                    cy.nodes().style('display', 'none');

                    // Show nodes of selected type
                    cy.nodes(`[type = "${filterType}"]`).style('display', 'element');

                    // Show edges between visible nodes
                    cy.edges().forEach(edge => {
                        const source = edge.source();
                        const target = edge.target();
                        if (source.style('display') === 'element' && target.style('display') === 'element') {
                            edge.style('display', 'element');
                        } else {
                            edge.style('display', 'none');
                        }
                    });
                }

                // Update stats
                const visibleNodes = cy.nodes('[ class="inl-56ab9741"]').length || cy.nodes().length;
                const visibleEdges = cy.edges('[ class="inl-56ab9741"]').length || cy.edges().length;
                document.getElementById('stat-nodes').textContent = visibleNodes;
                document.getElementById('stat-edges').textContent = visibleEdges;
            });
        });
    </script>

    <!-- Load Global Navigation -->
    <script>
        fetch('/public/components/global-nav.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('global-nav-container').innerHTML = html;
            });
    </script>
</body>
</html>
