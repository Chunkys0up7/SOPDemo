<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impact Analysis - Change Propagation Viewer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/public/assets/css/common.css">
    <link rel="stylesheet" href="/public/assets/css/global-nav-component.css">
    <link rel="stylesheet" href="/public/assets/css/impact-viewer-page.css">
</head>
<body>
    <!-- Inline styles extracted to impact-viewer-page.css (306 lines) for better maintainability -->
    <!-- Include Global Navigation -->
    <div id="global-nav-container"></div>

    <!-- Top Navigation -->
    <div id="top-nav">
        <a href="index.html">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
            </svg>
            Back to Dashboard
        </a>
        <span class="title">Impact Analysis Viewer</span>
    </div>

    <div id="container">
        <h1>üîç Impact Analysis</h1>
        <p class="subtitle">Visualize how changes propagate through the SOP ecosystem</p>

        <!-- Search Section -->
        <div id="search-section">
            <h2>Select Component to Analyze</h2>
            <div class="search-controls">
                <input type="text" id="component-search" placeholder="Search by ID or title...">
                <select id="change-type">
                    <option value="modification">Modification</option>
                    <option value="deletion">Deletion</option>
                    <option value="rename">Rename</option>
                </select>
            </div>
            <div id="suggestions"></div>
        </div>

        <!-- Risk Assessment -->
        <div id="risk-assessment">
            <h2>üìä Risk Assessment</h2>
            <div class="risk-grid">
                <div class="risk-card">
                    <div class="risk-value" id="direct-impacts">0</div>
                    <div class="risk-label">Direct Impacts</div>
                </div>
                <div class="risk-card">
                    <div class="risk-value" id="downstream-impacts">0</div>
                    <div class="risk-label">Downstream Impacts</div>
                </div>
                <div class="risk-card">
                    <div class="risk-value" id="affected-sops">0</div>
                    <div class="risk-label">Affected SOPs</div>
                </div>
                <div class="risk-card">
                    <div id="risk-level-badge"></div>
                    <div class="risk-label">Risk Level</div>
                </div>
            </div>
            <div id="selected-component" class="inl-8433d729">
                <strong>Analyzing:</strong> <span id="selected-name"></span>
            </div>
        </div>

        <!-- Impact Tree -->
        <div id="impact-tree">
            <h2>üå≥ Impact Propagation Tree</h2>
            <div id="tree-container">
                <svg id="tree-svg"></svg>
            </div>
        </div>

        <!-- Recommendations -->
        <div id="recommendations">
            <h2>üí° Recommendations</h2>
            <div id="rec-list"></div>
        </div>
    </div>

    <script>
        let graphData = null;
        let selectedComponent = null;

        // Load graph data
        fetch('../graph/sop-graph.json')
            .then(res => res.json())
            .then(data => {
                graphData = data;
                initializeSuggestions();
            })
            .catch(err => {
                console.error('Failed to load graph:', err);
            });

        function initializeSuggestions() {
            const nodes = Object.values(graphData.nodes);
            const suggestions = document.getElementById('suggestions');

            // Show popular components as suggestions
            const popular = [
                'atom-access-request-form',
                'molecule-account-setup',
                'organism-employee-onboarding',
                'sop-001-user-onboarding'
            ];

            popular.forEach(id => {
                const node = graphData.nodes[id];
                if (node) {
                    const chip = document.createElement('div');
                    chip.className = 'suggestion-chip';
                    chip.textContent = node.id;
                    chip.onclick = () => analyzeComponent(id);
                    suggestions.appendChild(chip);
                }
            });

            // Setup search
            const searchInput = document.getElementById('component-search');
            searchInput.addEventListener('input', handleSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const value = e.target.value.toLowerCase();
                    const match = Object.keys(graphData.nodes).find(id =>
                        id.toLowerCase().includes(value)
                    );
                    if (match) analyzeComponent(match);
                }
            });
        }

        function handleSearch(e) {
            const term = e.target.value.toLowerCase();
            if (term.length < 2) return;

            const matches = Object.keys(graphData.nodes)
                .filter(id => id.toLowerCase().includes(term) ||
                    graphData.nodes[id].title.toLowerCase().includes(term))
                .slice(0, 5);

            const suggestions = document.getElementById('suggestions');
            suggestions.innerHTML = '';

            matches.forEach(id => {
                const chip = document.createElement('div');
                chip.className = 'suggestion-chip';
                chip.textContent = id;
                chip.onclick = () => analyzeComponent(id);
                suggestions.appendChild(chip);
            });
        }

        function analyzeComponent(componentId) {
            selectedComponent = graphData.nodes[componentId];
            if (!selectedComponent) return;

            document.getElementById('selected-name').textContent = `${selectedComponent.id} - ${selectedComponent.title}`;

            // Calculate impact
            const impact = calculateImpact(componentId);

            // Update risk assessment
            document.getElementById('direct-impacts').textContent = impact.direct.length;
            document.getElementById('downstream-impacts').textContent = impact.downstream.length;
            document.getElementById('affected-sops').textContent = impact.affectedSOPs.length;

            const riskLevel = determineRiskLevel(impact);
            document.getElementById('risk-level-badge').innerHTML =
                `<span class="risk-level ${riskLevel.toLowerCase()}">${riskLevel.toUpperCase()}</span>`;

            document.getElementById('risk-assessment').classList.add('visible');

            // Draw tree
            drawImpactTree(componentId, impact);
            document.getElementById('impact-tree').classList.add('visible');

            // Generate recommendations
            generateRecommendations(impact, riskLevel);
            document.getElementById('recommendations').classList.add('visible');
        }

        function calculateImpact(componentId) {
            const direct = [];
            const downstream = [];
            const visited = new Set();
            const affectedSOPs = new Set();

            // Find direct dependencies (edges where this is the source)
            graphData.edges.forEach(edge => {
                if (edge.source === componentId) {
                    direct.push(edge.target);
                    findDownstream(edge.target, visited, downstream, affectedSOPs);
                }
            });

            return {
                direct: Array.from(new Set(direct)),
                downstream: Array.from(downstream),
                affectedSOPs: Array.from(affectedSOPs)
            };
        }

        function findDownstream(nodeId, visited, downstream, affectedSOPs) {
            if (visited.has(nodeId)) return;
            visited.add(nodeId);

            const node = graphData.nodes[nodeId];
            if (node && node.type === 'sop') {
                affectedSOPs.add(nodeId);
            }

            graphData.edges.forEach(edge => {
                if (edge.source === nodeId) {
                    downstream.push(edge.target);
                    findDownstream(edge.target, visited, downstream, affectedSOPs);
                }
            });
        }

        function determineRiskLevel(impact) {
            const total = impact.direct.length + impact.downstream.length;
            const sopCount = impact.affectedSOPs.length;

            if (sopCount >= 5 || total >= 20) return 'CRITICAL';
            if (sopCount >= 3 || total >= 10) return 'HIGH';
            if (sopCount >= 1 || total >= 5) return 'MEDIUM';
            return 'LOW';
        }

        function drawImpactTree(rootId, impact) {
            const margin = {top: 20, right: 120, bottom: 20, left: 120};
            const width = 1200 - margin.right - margin.left;
            const height = 600 - margin.top - margin.bottom;

            // Clear previous
            d3.select('#tree-svg').selectAll('*').remove();

            const svg = d3.select('#tree-svg')
                .attr('width', width + margin.right + margin.left)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Build tree structure
            const root = {
                name: rootId,
                type: 'root',
                children: impact.direct.map(id => ({
                    name: id,
                    type: 'direct',
                    children: getChildren(id, impact.downstream)
                }))
            };

            const treeLayout = d3.tree().size([height, width]);
            const rootNode = d3.hierarchy(root);
            treeLayout(rootNode);

            // Draw links
            g.selectAll('.tree-link')
                .data(rootNode.links())
                .join('path')
                .attr('class', 'tree-link')
                .attr('d', d3.linkHorizontal()
                    .x(d => d.y)
                    .y(d => d.x));

            // Draw nodes
            const nodes = g.selectAll('.tree-node-group')
                .data(rootNode.descendants())
                .join('g')
                .attr('transform', d => `translate(${d.y},${d.x})`);

            nodes.append('circle')
                .attr('class', d => `tree-node ${d.data.type}`)
                .attr('r', d => d.data.type === 'root' ? 8 : 6);

            nodes.append('text')
                .attr('class', 'tree-text')
                .attr('dy', '0.31em')
                .attr('x', d => d.children ? -12 : 12)
                .attr('text-anchor', d => d.children ? 'end' : 'start')
                .text(d => d.data.name.split('-').slice(-1)[0]);
        }

        function getChildren(nodeId, downstreamList) {
            const children = [];
            graphData.edges.forEach(edge => {
                if (edge.source === nodeId && downstreamList.includes(edge.target)) {
                    children.push({
                        name: edge.target,
                        type: 'downstream'
                    });
                }
            });
            return children;
        }

        function generateRecommendations(impact, riskLevel) {
            const recList = document.getElementById('rec-list');
            recList.innerHTML = '';

            const recs = [];

            if (riskLevel === 'CRITICAL') {
                recs.push({
                    type: 'critical',
                    icon: 'üö®',
                    text: 'CRITICAL: Review all ' + impact.affectedSOPs.length + ' affected SOPs before publishing changes'
                });
                recs.push({
                    type: 'warning',
                    icon: '‚ö†Ô∏è',
                    text: 'Notify department leads and stakeholders immediately'
                });
                recs.push({
                    type: 'warning',
                    icon: 'üìÖ',
                    text: 'Consider phased rollout over 2-4 weeks to minimize disruption'
                });
            } else if (riskLevel === 'HIGH') {
                recs.push({
                    type: 'warning',
                    icon: '‚ö†Ô∏è',
                    text: 'Review all ' + impact.affectedSOPs.length + ' affected SOPs before publishing'
                });
                recs.push({
                    type: 'normal',
                    icon: 'üìß',
                    text: 'Notify department leads of upcoming changes'
                });
            } else if (riskLevel === 'MEDIUM') {
                recs.push({
                    type: 'normal',
                    icon: '‚úì',
                    text: 'Review affected SOPs and update training materials'
                });
            } else {
                recs.push({
                    type: 'normal',
                    icon: '‚úì',
                    text: 'Low risk change - standard review process applies'
                });
            }

            recs.forEach(rec => {
                const div = document.createElement('div');
                div.className = `recommendation ${rec.type}`;
                div.innerHTML = `<span class="rec-icon">${rec.icon}</span>${rec.text}`;
                recList.appendChild(div);
            });
        }
    </script>
    <!-- Load Global Navigation -->
    <script>
        fetch('/public/components/global-nav.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('global-nav-container').innerHTML = html;
            });
    </script>
</body>
</html>
