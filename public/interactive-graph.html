<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive SOP Graph - Live Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27;
            color: #e0e6f0;
            overflow: hidden;
        }

        #container {
            display: flex;
            height: 100vh;
            padding-top: 50px;
        }

        /* Sidebar */
        #sidebar {
            width: 320px;
            background: #131829;
            border-right: 1px solid #1e2439;
            overflow-y: auto;
            padding: 20px;
        }

        #sidebar h2 {
            color: #60a5fa;
            margin-bottom: 20px;
            font-size: 18px;
        }

        #stats {
            background: #1a1f35;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #2a3150;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #9ca3af;
            font-size: 13px;
        }

        .stat-value {
            color: #60a5fa;
            font-weight: 600;
        }

        /* Filters */
        #filters {
            margin-top: 20px;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            color: #9ca3af;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            background: #1a1f35;
            border: 1px solid #2a3150;
            border-radius: 6px;
            color: #e0e6f0;
            font-size: 14px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #60a5fa;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .checkbox-label:hover {
            background: #1a1f35;
        }

        input[type="checkbox"] {
            margin-right: 10px;
        }

        .type-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        button {
            width: 100%;
            padding: 10px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }

        button:hover {
            background: #2563eb;
        }

        button.secondary {
            background: #374151;
        }

        button.secondary:hover {
            background: #4b5563;
        }

        /* Top Navigation */
        #top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: rgba(19, 24, 41, 0.95);
            border-bottom: 1px solid #2a3150;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        #top-nav a {
            color: #60a5fa;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.2s;
        }

        #top-nav a:hover {
            color: #93c5fd;
        }

        #top-nav .title {
            margin-left: auto;
            color: #e0e6f0;
            font-weight: 600;
        }

        /* Graph Canvas */
        #graph-container {
            flex: 1;
            position: relative;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        /* Graph Elements */
        .link {
            stroke: #2a3150;
            stroke-width: 2px;
            fill: none;
        }

        .link.strong {
            stroke: #60a5fa;
            stroke-width: 3px;
        }

        .link.component-of {
            stroke: #8b5cf6;
        }

        .link.depends-on {
            stroke: #f59e0b;
        }

        .link.related-to {
            stroke: #10b981;
            stroke-dasharray: 5,5;
        }

        .link.highlighted {
            stroke: #fbbf24;
            stroke-width: 4px;
        }

        .node circle {
            cursor: pointer;
            stroke-width: 2px;
        }

        .node.atom circle {
            fill: #3b82f6;
            stroke: #60a5fa;
        }

        .node.molecule circle {
            fill: #8b5cf6;
            stroke: #a78bfa;
        }

        .node.organism circle {
            fill: #10b981;
            stroke: #34d399;
        }

        .node.sop circle {
            fill: #ef4444;
            stroke: #f87171;
        }

        .node.highlighted circle {
            stroke: #fbbf24;
            stroke-width: 4px;
        }

        .node.faded {
            opacity: 0.2;
        }

        .node text {
            font-size: 11px;
            pointer-events: none;
            fill: #e0e6f0;
            text-anchor: middle;
            dominant-baseline: central;
        }

        /* Tooltip */
        #tooltip {
            position: absolute;
            background: #1a1f35;
            border: 1px solid #60a5fa;
            border-radius: 8px;
            padding: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 300px;
            z-index: 1000;
        }

        #tooltip.visible {
            opacity: 1;
        }

        #tooltip h3 {
            color: #60a5fa;
            margin-bottom: 8px;
            font-size: 14px;
        }

        #tooltip .info-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
        }

        #tooltip .info-label {
            color: #9ca3af;
        }

        #tooltip .info-value {
            color: #e0e6f0;
            font-weight: 500;
        }

        /* Controls */
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #131829;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #1e2439;
        }

        #controls button {
            width: auto;
            margin: 5px;
            padding: 8px 16px;
            display: inline-block;
        }

        /* Legend */
        #legend {
            position: absolute;
            bottom: 20px;
            left: 340px;
            background: #131829;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #1e2439;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 12px;
        }

        .legend-item .circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
        }

        /* Loading */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 18px;
            color: #60a5fa;
        }
    <!-- Page-specific inline styles migrated to /public/assets/css/common.css -->
<body>
    <!-- Top Navigation -->
    <div id="top-nav">
        <a href="index.html">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
            </svg>
            Back to Dashboard
        </a>
        <span class="title">Interactive Graph Viewer</span>
    </div>

    <div id="container">
        <!-- Sidebar -->
        <div id="sidebar">
            <h2>üìä Graph Explorer</h2>

            <div id="stats">
                <div class="stat-row">
                    <span class="stat-label">Total Nodes</span>
                    <span class="stat-value" id="stat-total">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Visible Nodes</span>
                    <span class="stat-value" id="stat-visible">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Edges</span>
                    <span class="stat-value" id="stat-edges">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Selected</span>
                    <span class="stat-value" id="stat-selected">None</span>
                </div>
            </div>

            <div id="filters">
                <div class="filter-group">
                    <label>üîç Search by ID or Title</label>
                    <input type="text" id="search-input" placeholder="Type to search...">
                </div>

                <div class="filter-group">
                    <label>üè∑Ô∏è Filter by Type</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" class="type-filter" value="atom" checked>
                            <span class="type-indicator" style="background: #3b82f6"></span>
                            Atoms
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="type-filter" value="molecule" checked>
                            <span class="type-indicator" style="background: #8b5cf6"></span>
                            Molecules
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="type-filter" value="organism" checked>
                            <input type="checkbox" class="type-filter" value="organism" checked>
                            <span class="type-indicator" style="background: #10b981"></span>
                            Organisms
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="type-filter" value="sop" checked>
                            <span class="type-indicator" style="background: #ef4444"></span>
                            SOPs
                        </label>
                    </div>
                </div>

                <button id="reset-btn" class="secondary">Reset Filters</button>
                <button id="reset-zoom-btn">Reset Zoom</button>
            </div>
        </div>

        <!-- Graph Container -->
        <div id="graph-container">
            <div id="loading">Loading graph data...</div>
            <svg id="graph-svg"></svg>

            <div id="controls">
                <button id="zoom-in-btn">Zoom In</button>
                <button id="zoom-out-btn">Zoom Out</button>
            </div>

            <div id="legend">
                <div class="legend-item">
                    <div class="circle" style="background: #3b82f6; border: 2px solid #60a5fa;"></div>
                    <span>Atom (base component)</span>
                </div>
                <div class="legend-item">
                    <div class="circle" style="background: #8b5cf6; border: 2px solid #a78bfa;"></div>
                    <span>Molecule (task sequence)</span>
                </div>
                <div class="legend-item">
                    <div class="circle" style="background: #10b981; border: 2px solid #34d399;"></div>
                    <span>Organism (workflow)</span>
                </div>
                <div class="legend-item">
                    <div class="circle" style="background: #ef4444; border: 2px solid #f87171;"></div>
                    <span>SOP (complete procedure)</span>
                </div>
            </div>

            <div id="tooltip"></div>
        </div>
    </div>

    <script>
        // Load graph data and initialize visualization
        let graphData = null;
        let simulation = null;
        let svg, g, link, node, zoom;
        let selectedNode = null;

        const width = window.innerWidth - 320;
        const height = window.innerHeight;

        // Initialize SVG
        svg = d3.select('#graph-svg')
            .attr('width', width)
            .attr('height', height);

        g = svg.append('g');

        // Setup zoom
        zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);

        // Load data
        fetch('../graph/sop-graph.json')
            .then(res => res.json())
            .then(data => {
                graphData = data;
                document.getElementById('loading').style.display = 'none';
                initializeGraph();
            })
            .catch(err => {
                document.getElementById('loading').innerHTML = '‚ùå Failed to load graph data: ' + err.message;
            });

        function initializeGraph() {
            // Convert nodes object to array
            const nodes = Object.values(graphData.nodes).map(d => ({...d}));
            const edges = graphData.edges.map(d => ({...d}));

            // Update stats
            document.getElementById('stat-total').textContent = nodes.length;
            document.getElementById('stat-visible').textContent = nodes.length;
            document.getElementById('stat-edges').textContent = edges.length;

            // Create force simulation
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(edges).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));

            // Create links
            link = g.append('g')
                .selectAll('line')
                .data(edges)
                .join('line')
                .attr('class', d => `link ${d.type} ${d.strength}`)
                .attr('marker-end', 'url(#arrowhead)');

            // Add arrowhead marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '-0 -5 10 10')
                .attr('refX', 25)
                .attr('refY', 0)
                .attr('orient', 'auto')
                .attr('markerWidth', 8)
                .attr('markerHeight', 8)
                .append('path')
                .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
                .attr('fill', '#2a3150');

            // Create nodes
            const nodeGroups = g.append('g')
                .selectAll('g')
                .data(nodes)
                .join('g')
                .attr('class', d => `node ${d.type}`)
                .call(drag(simulation))
                .on('click', handleNodeClick)
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);

            nodeGroups.append('circle')
                .attr('r', d => {
                    if (d.type === 'sop') return 20;
                    if (d.type === 'organism') return 16;
                    if (d.type === 'molecule') return 12;
                    return 8;
                });

            nodeGroups.append('text')
                .attr('dy', 30)
                .text(d => d.id.split('-').pop().substring(0, 15));

            node = nodeGroups;

            // Update positions on simulation tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            setupEventListeners();
        }

        function setupEventListeners() {
            // Search
            document.getElementById('search-input').addEventListener('input', filterGraph);

            // Type filters
            document.querySelectorAll('.type-filter').forEach(checkbox => {
                checkbox.addEventListener('change', filterGraph);
            });

            // Reset buttons
            document.getElementById('reset-btn').addEventListener('click', resetFilters);
            document.getElementById('reset-zoom-btn').addEventListener('click', resetZoom);
            document.getElementById('zoom-in-btn').addEventListener('click', () => svg.transition().call(zoom.scaleBy, 1.3));
            document.getElementById('zoom-out-btn').addEventListener('click', () => svg.transition().call(zoom.scaleBy, 0.7));
        }

        function filterGraph() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const activeTypes = Array.from(document.querySelectorAll('.type-filter:checked')).map(cb => cb.value);

            let visibleCount = 0;

            node.style('display', function(d) {
                const matchesSearch = !searchTerm || d.id.toLowerCase().includes(searchTerm) || d.title.toLowerCase().includes(searchTerm);
                const matchesType = activeTypes.includes(d.type);
                const visible = matchesSearch && matchesType;

                if (visible) visibleCount++;
                return visible ? 'block' : 'none';
            });

            document.getElementById('stat-visible').textContent = visibleCount;
        }

        function handleNodeClick(event, d) {
            selectedNode = d;
            document.getElementById('stat-selected').textContent = d.id;

            // Highlight connected nodes
            const connectedNodes = new Set();
            connectedNodes.add(d.id);

            link.each(function(l) {
                if (l.source.id === d.id) connectedNodes.add(l.target.id);
                if (l.target.id === d.id) connectedNodes.add(l.source.id);
            });

            node.classed('faded', n => !connectedNodes.has(n.id));
            node.classed('highlighted', n => n.id === d.id);
            link.classed('highlighted', l => l.source.id === d.id || l.target.id === d.id);
        }

        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <h3>${d.title}</h3>
                <div class="info-row">
                    <span class="info-label">ID:</span>
                    <span class="info-value">${d.id}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Type:</span>
                    <span class="info-value">${d.type}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Department:</span>
                    <span class="info-value">${d.department || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span class="info-value">${d.status || 'N/A'}</span>
                </div>
            `;
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            tooltip.classList.add('visible');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }

        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.querySelectorAll('.type-filter').forEach(cb => cb.checked = true);
            node.classed('faded', false).classed('highlighted', false);
            link.classed('highlighted', false);
            selectedNode = null;
            document.getElementById('stat-selected').textContent = 'None';
            filterGraph();
        }

        function resetZoom() {
            svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
        }

        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            return d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended);
        }
    </script>
</body>
</html>
