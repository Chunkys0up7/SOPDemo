<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOP Assistant - AI-Powered Procedure Builder</title>
  <style>
    :root {
      --primary-color: #0052CC;
      --primary-dark: #003d99;
      --text-dark: #2d3748;
      --text-light: #718096;
      --border-color: #e2e8f0;
      --bg-light: #f7fafc;
      --success-color: #48bb78;
      --warning-color: #ed8936;
      --danger-color: #f56565;
      --info-color: #4299e1;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-light);
      min-height: 100vh;
    }

    .page-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 20px;
      height: calc(100vh - 105px);
    }

    /* Sidebar */
    .sidebar {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      overflow-y: auto;
    }

    .sidebar h2 {
      font-size: 18px;
      color: var(--text-dark);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .example-queries {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .example-query {
      background: var(--bg-light);
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      color: var(--text-dark);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .example-query:hover {
      background: #eef2ff;
      border-color: var(--primary-color);
    }

    .sidebar-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border-color);
    }

    .setting-item {
      margin-bottom: 16px;
    }

    .setting-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 6px;
      display: block;
    }

    .setting-select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }

    .toggle-switch {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .toggle-switch input {
      width: 40px;
      height: 20px;
      cursor: pointer;
    }

    /* Main Chat Area */
    .chat-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, #0052CC 0%, #003d99 100%);
      color: white;
      padding: 20px 24px;
      border-radius: 12px 12px 0 0;
    }

    .chat-header h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .chat-header p {
      font-size: 14px;
      opacity: 0.95;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      background: #fafafa;
    }

    .message {
      margin-bottom: 24px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user .message-content {
      background: var(--primary-color);
      color: white;
      margin-left: auto;
      max-width: 70%;
      border-radius: 18px 18px 4px 18px;
    }

    .message.assistant .message-content {
      background: white;
      border: 1px solid var(--border-color);
      max-width: 100%;
      border-radius: 18px 18px 18px 4px;
    }

    .message-content {
      padding: 16px 20px;
      font-size: 15px;
      line-height: 1.6;
    }

    .message-meta {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Retrieved Sources */
    .retrieved-sources {
      background: #f0f9ff;
      border-left: 4px solid var(--info-color);
      padding: 16px;
      border-radius: 8px;
      margin-top: 12px;
    }

    .sources-header {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-dark);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .source-item {
      background: white;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      border: 1px solid #bfdbfe;
    }

    .source-item:last-child {
      margin-bottom: 0;
    }

    .source-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .source-title {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-dark);
    }

    .relevance-score {
      font-size: 11px;
      padding: 2px 8px;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 10px;
      font-weight: 600;
    }

    .source-excerpt {
      font-size: 13px;
      color: var(--text-light);
      line-height: 1.5;
      font-style: italic;
    }

    .source-link {
      font-size: 12px;
      color: var(--info-color);
      text-decoration: none;
      margin-top: 6px;
      display: inline-block;
    }

    .source-link:hover {
      text-decoration: underline;
    }

    /* Generated Content */
    .generated-content {
      background: #f0fdf4;
      border-left: 4px solid var(--success-color);
      padding: 16px;
      border-radius: 8px;
      margin-top: 12px;
    }

    .generated-header {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-dark);
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .generated-text {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-dark);
    }

    .generated-text h3 {
      font-size: 16px;
      margin: 16px 0 8px 0;
    }

    .generated-text h4 {
      font-size: 14px;
      margin: 12px 0 6px 0;
      font-weight: 600;
    }

    .generated-text ol, .generated-text ul {
      margin-left: 20px;
      margin-bottom: 12px;
    }

    .generated-text li {
      margin-bottom: 6px;
    }

    .generated-text p {
      margin-bottom: 10px;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: white;
      color: var(--text-dark);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-light);
    }

    /* Input Area */
    .chat-input-container {
      padding: 20px 24px;
      background: white;
      border-top: 1px solid var(--border-color);
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      resize: none;
      max-height: 150px;
      min-height: 48px;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .send-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 15px;
    }

    .send-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .send-btn:disabled {
      background: var(--border-color);
      cursor: not-allowed;
      transform: none;
    }

    /* Loading Indicator */
    .loading-message {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-light);
      font-size: 14px;
    }

    .loading-dots {
      display: flex;
      gap: 4px;
    }

    .loading-dots span {
      width: 8px;
      height: 8px;
      background: var(--text-light);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* Info Banner */
    .info-banner {
      background: #fef3c7;
      border-left: 4px solid var(--warning-color);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 13px;
      line-height: 1.5;
    }

    .info-banner strong {
      color: var(--text-dark);
    }

    @media (max-width: 1024px) {
      .page-container {
        grid-template-columns: 1fr;
        height: auto;
      }

      .sidebar {
        order: 2;
      }

      .chat-container {
        min-height: 70vh;
      }
    }
  </style>
</head>
<body>
  <!-- Global Navigation -->
  <script>
    fetch('/public/components/global-nav.html')
      .then(response => response.text())
      .then(html => {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        document.body.insertBefore(tempDiv.firstChild, document.body.firstChild);
      });
  </script>

  <div class="page-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <h2>ü§ñ SOP Assistant</h2>
      <p style="font-size: 13px; color: var(--text-light); margin-bottom: 20px;">
        Ask questions or describe what procedure you need. The assistant will search existing SOPs and generate tailored responses.
      </p>

      <div class="info-banner">
        <strong>üí° How it works:</strong> Your query is embedded and compared against all SOP sections. The most relevant content is retrieved and sent to an LLM to generate a comprehensive answer.
      </div>

      <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Example Queries</h3>
      <div class="example-queries">
        <div class="example-query" onclick="useExample('How do I process an invoice over $10,000?')">
          üí∞ "How do I process an invoice over $10,000?"
        </div>
        <div class="example-query" onclick="useExample('Create an onboarding checklist for a new finance team member')">
          üëã "Create an onboarding checklist for a new finance team member"
        </div>
        <div class="example-query" onclick="useExample('What are the steps for requesting IT system access?')">
          üîê "What are the steps for requesting IT system access?"
        </div>
        <div class="example-query" onclick="useExample('Generate a troubleshooting guide for invoice approval delays')">
          üîß "Generate a troubleshooting guide for invoice approval delays"
        </div>
        <div class="example-query" onclick="useExample('What training is required before processing invoices?')">
          üéì "What training is required before processing invoices?"
        </div>
      </div>

      <div class="sidebar-section">
        <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Settings</h3>

        <div class="setting-item">
          <label class="setting-label">LLM Provider</label>
          <select class="setting-select" id="llmProvider">
            <option value="mock">Mock (Demo)</option>
            <option value="openai">OpenAI GPT-4</option>
            <option value="anthropic">Anthropic Claude</option>
          </select>
        </div>

        <div class="setting-item">
          <label class="setting-label">Retrieval Mode</label>
          <select class="setting-select" id="retrievalMode">
            <option value="semantic">Semantic Search</option>
            <option value="keyword">Keyword Match</option>
            <option value="hybrid">Hybrid (Both)</option>
          </select>
        </div>

        <div class="setting-item">
          <label class="setting-label">Max Sources</label>
          <select class="setting-select" id="maxSources">
            <option value="3">3 sources</option>
            <option value="5" selected>5 sources</option>
            <option value="10">10 sources</option>
          </select>
        </div>

        <div class="setting-item">
          <label class="toggle-switch">
            <input type="checkbox" id="showSources" checked>
            <span style="font-size: 13px;">Show retrieved sources</span>
          </label>
        </div>

        <div class="setting-item">
          <label class="toggle-switch">
            <input type="checkbox" id="enableCitations">
            <span style="font-size: 13px;">Include inline citations</span>
          </label>
        </div>
      </div>

      <div class="sidebar-section">
        <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">Knowledge Base Stats</h3>
        <div id="kb-stats" style="font-size: 13px; color: var(--text-light); line-height: 1.8;">
          üìö Loading stats...<br>
          ‚è≥ Please wait
        </div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-container">
      <div class="chat-header">
        <h1>üí¨ SOP Assistant Chat</h1>
        <p>Ask anything about your organization's procedures. I'll search the knowledge base and generate helpful responses.</p>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="message assistant">
          <div class="message-content">
            <p>üëã Hello! I'm your SOP Assistant, powered by RAG (Retrieval Augmented Generation).</p>
            <p>I can help you:</p>
            <ul>
              <li>Answer questions about existing procedures</li>
              <li>Generate new SOPs based on organizational knowledge</li>
              <li>Find relevant information across all documentation</li>
              <li>Create customized checklists and guides</li>
            </ul>
            <p>Try asking a question or selecting an example from the sidebar!</p>
          </div>
          <div class="message-meta">ü§ñ SOP Assistant ‚Ä¢ Just now</div>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <textarea
            id="chatInput"
            class="chat-input"
            placeholder="Ask about procedures, request new SOPs, or search the knowledge base..."
            rows="1"
          ></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    let isProcessing = false;

    // Mock SOP knowledge base for RAG
    const sopKnowledgeBase = [
      {
        sopId: 'sop-001',
        sopTitle: 'Invoice Processing',
        section: 'Approval Routing',
        content: 'Route to department manager for approval. Route to Finance Controller if >$10,000. Route to CFO if >$50,000. Track approval status in workflow system. Validate expense categories against approved list.',
        embedding: [0.23, 0.45, 0.67], // Mock embedding
        metadata: { department: 'Finance', version: '1.2.0' }
      },
      {
        sopId: 'sop-001',
        sopTitle: 'Invoice Processing',
        section: 'Prerequisites',
        content: 'Access Requirements: ERP system credentials (see SOP-002 for access provisioning), Accounts Payable module permissions. Required Training: Finance onboarding (SOP-003), Invoice processing certification. Tools & Systems: ERP system (SAP/Oracle), Invoice scanning software, Approval workflow system.',
        embedding: [0.12, 0.34, 0.56],
        metadata: { department: 'Finance', version: '1.2.0' }
      },
      {
        sopId: 'sop-002',
        sopTitle: 'IT System Access Provisioning',
        section: 'Request Process',
        content: 'Submit access request through ServiceNow portal. Include: System name, Access level required, Business justification, Manager approval. IT will provision within 24 hours for standard access.',
        embedding: [0.45, 0.23, 0.78],
        metadata: { department: 'IT', version: '2.0.1' }
      },
      {
        sopId: 'sop-003',
        sopTitle: 'Security Training Completion',
        section: 'Required Modules',
        content: 'All employees must complete: Data Security 101, Phishing Awareness, Password Best Practices, Incident Reporting. Complete within first 30 days of employment. Annual refresher required.',
        embedding: [0.34, 0.56, 0.12],
        metadata: { department: 'Security', version: '1.5.0' }
      },
      {
        sopId: 'sop-005',
        sopTitle: 'Comprehensive HR Onboarding',
        section: 'Day 1 Checklist',
        content: 'Welcome meeting with manager. IT system access setup (see SOP-002). Security training enrollment (SOP-003). Workspace and equipment assignment. Team introductions. Review first week schedule.',
        embedding: [0.67, 0.12, 0.34],
        metadata: { department: 'HR', version: '3.1.0' }
      },
      {
        sopId: 'sop-001',
        sopTitle: 'Invoice Processing',
        section: 'Troubleshooting',
        content: 'Invoice Doesnt Match PO: Verify PO number is correct, Check for partial deliveries, Contact purchasing department, May require PO amendment. Missing Approval: Check approval workflow status, Send reminder to approver, Escalate to manager if >3 days overdue.',
        embedding: [0.56, 0.78, 0.23],
        metadata: { department: 'Finance', version: '1.2.0' }
      }
    ];

    // Auto-resize textarea
    const chatInput = document.getElementById('chatInput');
    chatInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 150) + 'px';
    });

    // Send message on Enter (Shift+Enter for new line)
    chatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Use example query
    function useExample(text) {
      document.getElementById('chatInput').value = text;
      chatInput.style.height = 'auto';
      chatInput.style.height = chatInput.scrollHeight + 'px';
      chatInput.focus();
    }

    // Send message
    async function sendMessage() {
      if (isProcessing) return;

      const input = document.getElementById('chatInput');
      const query = input.value.trim();

      if (!query) return;

      // Clear input
      input.value = '';
      input.style.height = 'auto';

      // Add user message
      addMessage('user', query);

      // Show loading
      isProcessing = true;
      document.getElementById('sendBtn').disabled = true;
      addLoadingMessage();

      try {
        // Call production RAG API
        const maxSources = parseInt(document.getElementById('maxSources').value);
        const apiResponse = await fetch('/api/assistant/query', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            query: query,
            topK: maxSources
          })
        });

        if (!apiResponse.ok) {
          throw new Error(`API error: ${apiResponse.status}`);
        }

        const data = await apiResponse.json();

        // Remove loading message
        removeLoadingMessage();

        // Add assistant response with actual sources
        addAssistantMessage({
          text: data.answer,
          type: 'answer'
        }, data.sources.map(s => ({
          sopId: s.sopId,
          sopTitle: s.title,
          section: s.section,
          relevanceScore: s.relevance / 100,
          content: '' // Not returned from API for performance
        })));

      } catch (error) {
        console.error('Assistant API error:', error);
        removeLoadingMessage();

        // Show error message
        addAssistantMessage({
          text: `I encountered an error processing your request: ${error.message}\n\nPlease try again or contact support if the issue persists.`,
          type: 'error'
        }, []);
      }

      // Re-enable input
      isProcessing = false;
      document.getElementById('sendBtn').disabled = false;
      input.focus();
    }

    // Retrieve relevant sources using mock vector search
    async function retrieveRelevantSources(query) {
      const maxSources = parseInt(document.getElementById('maxSources').value);
      const retrievalMode = document.getElementById('retrievalMode').value;

      // Mock relevance scoring (in production, use actual embedding similarity)
      const scoredSources = sopKnowledgeBase.map(source => {
        let score = 0;

        // Simple keyword matching for demo
        const queryLower = query.toLowerCase();
        const contentLower = source.content.toLowerCase();

        // Keyword overlap
        const queryWords = queryLower.split(' ');
        queryWords.forEach(word => {
          if (contentLower.includes(word)) score += 0.1;
        });

        // Boost for exact phrase matches
        if (contentLower.includes(queryLower.substring(0, 20))) {
          score += 0.3;
        }

        // Department relevance
        if (query.includes('invoice') || query.includes('finance')) {
          if (source.metadata.department === 'Finance') score += 0.2;
        }
        if (query.includes('onboard') || query.includes('new hire')) {
          if (source.metadata.department === 'HR') score += 0.2;
        }
        if (query.includes('access') || query.includes('system')) {
          if (source.metadata.department === 'IT') score += 0.2;
        }

        return { ...source, relevanceScore: Math.min(score, 0.99) };
      });

      // Sort by relevance and take top K
      const topSources = scoredSources
        .sort((a, b) => b.relevanceScore - a.relevanceScore)
        .slice(0, maxSources)
        .filter(s => s.relevanceScore > 0.1); // Minimum threshold

      return topSources;
    }

    // Generate response using LLM (mock for now)
    async function generateResponse(query, sources) {
      const provider = document.getElementById('llmProvider').value;

      if (provider === 'mock') {
        // Mock response generation based on query
        return generateMockResponse(query, sources);
      } else {
        // In production, call actual LLM API
        return {
          text: `This would call ${provider} API with the query and retrieved sources to generate a response.`,
          type: 'info'
        };
      }
    }

    // Mock response generator
    function generateMockResponse(query, sources) {
      const queryLower = query.toLowerCase();

      // Invoice processing query
      if (queryLower.includes('invoice') && queryLower.includes('10000')) {
        return {
          text: `Based on the Invoice Processing SOP, here's how to process an invoice over $10,000:

### Approval Workflow for High-Value Invoices

**Step 1: Initial Review**
- Verify invoice contains all required information (PO number, vendor details, itemized charges)
- Ensure three-way match is complete (PO, receiving report, invoice)

**Step 2: Approval Routing**
Since the invoice exceeds $10,000, it requires escalated approval:
1. Route to Department Manager for initial approval
2. **Route to Finance Controller** (required for amounts >$10,000)
3. If the invoice exceeds $50,000, CFO approval is also required
4. Track approval status in the workflow system

**Step 3: Validation**
- Validate expense categories against approved list
- Verify budget availability

**Step 4: Processing**
- Once all approvals are obtained, process payment according to terms
- Record transaction in general ledger
- Send payment confirmation to vendor

### Prerequisites
Before processing, ensure you have:
- ERP system credentials with Accounts Payable module permissions
- Completed Finance onboarding (SOP-003)
- Invoice processing certification

**Reference:** Invoice Processing SOP (SOP-001 v1.2.0)`,
          type: 'procedure'
        };
      }

      // Onboarding query
      if (queryLower.includes('onboard') && queryLower.includes('finance')) {
        return {
          text: `Here's a customized onboarding checklist for a new Finance team member:

### Finance Team Member Onboarding Checklist

#### Day 1
- [ ] Welcome meeting with Finance Manager
- [ ] IT system access setup
  - ERP system (SAP/Oracle) credentials - follow SOP-002
  - Accounts Payable module permissions
  - Invoice scanning software access
  - Approval workflow system login
- [ ] Security training enrollment - complete SOP-003 modules
- [ ] Workspace and equipment assignment
- [ ] Team introductions
- [ ] Review first week schedule

#### Week 1
- [ ] Complete Finance onboarding training (SOP-003)
- [ ] Shadow experienced team member on invoice processing
- [ ] Review Invoice Processing SOP (SOP-001)
- [ ] Learn approval workflow system
- [ ] Complete invoice processing certification

#### Week 2-4
- [ ] Process first invoices under supervision
- [ ] Learn troubleshooting procedures for common issues
- [ ] Understand approval thresholds ($10K, $50K escalations)
- [ ] Practice three-way matching
- [ ] Review expense category validation

#### Month 1 Checkpoint
- [ ] Complete all required security training modules
- [ ] Successfully process 20+ invoices independently
- [ ] Demonstrate proficiency in approval routing
- [ ] Manager review and feedback session

**This checklist combines procedures from:**
- HR Onboarding SOP (SOP-005)
- Invoice Processing SOP (SOP-001)
- IT Access Provisioning SOP (SOP-002)
- Security Training SOP (SOP-003)`,
          type: 'checklist'
        };
      }

      // IT access query
      if (queryLower.includes('access') || queryLower.includes('system')) {
        return {
          text: `Here's how to request IT system access:

### IT System Access Request Process

**Step 1: Submit Request**
- Access the ServiceNow portal
- Fill out the access request form

**Step 2: Required Information**
Provide the following details:
- System name (e.g., ERP, CRM, specific application)
- Access level required (Read-only, Standard User, Admin)
- Business justification (why you need access)
- Manager approval (must be obtained before submission)

**Step 3: Processing Timeline**
- **Standard access:** IT will provision within 24 hours
- **Elevated access:** May require additional security review (2-3 business days)

**Step 4: Activation**
- You'll receive email notification when access is granted
- Initial password will be sent separately via secure channel
- Must complete security training (SOP-003) before access is activated

### Common Access Types
- **ERP System (SAP/Oracle):** Required for Finance team members
- **Accounts Payable Module:** Specific permission for invoice processors
- **Approval Workflow System:** For managers and approvers

**Reference:** IT System Access Provisioning SOP (SOP-002 v2.0.1)`,
          type: 'guide'
        };
      }

      // Troubleshooting query
      if (queryLower.includes('troubleshoot') || queryLower.includes('delay')) {
        return {
          text: `Here's a troubleshooting guide for invoice approval delays:

### Troubleshooting: Invoice Approval Delays

#### Symptom: Invoice Stuck in Approval Queue

**Step 1: Check Approval Status**
- Log into approval workflow system
- View invoice approval history
- Identify which approver is pending

**Step 2: Verify Correct Routing**
- Confirm invoice amount:
  - <$10,000: Department Manager only
  - $10,000-$49,999: Manager + Finance Controller
  - $50,000+: Manager + Controller + CFO
- Check if invoice was routed to correct approvers
- Verify approver is active (not on vacation/leave)

**Step 3: Take Action Based on Timeline**

**0-3 days:** Monitor status
- Most approvals complete within this window
- No action needed yet

**3-5 days:** Send reminder
- Use workflow system's reminder function
- Include invoice number and urgency level
- CC the approver's assistant if available

**5+ days:** Escalate
- Contact approver's manager
- Explain impact of delay (vendor payment terms, late fees)
- Request expedited review
- Document escalation in system

**Step 4: Prevent Future Delays**
- Set up automatic reminder emails (day 3, day 5)
- Configure escalation rules in workflow system
- Review approver workload and distribution

#### Common Root Causes

**Missing Information:**
- Incomplete invoice details ‚Üí Request clarification from vendor
- Mismatched PO ‚Üí Contact purchasing department

**System Issues:**
- Workflow notification not sent ‚Üí Check spam folders, resend notification
- Approver locked out of system ‚Üí Contact IT (SOP-002)

**Reference:** Invoice Processing SOP (SOP-001 v1.2.0), Section: Troubleshooting`,
          type: 'troubleshooting'
        };
      }

      // Training query
      if (queryLower.includes('training') || queryLower.includes('required')) {
        return {
          text: `Here's the required training before processing invoices:

### Required Training for Invoice Processors

#### Security Training (SOP-003)
All employees must complete these modules **within first 30 days:**
1. **Data Security 101** - Protecting financial information
2. **Phishing Awareness** - Recognizing fraudulent vendor emails
3. **Password Best Practices** - Securing system access
4. **Incident Reporting** - What to do if you suspect fraud

üìÖ **Annual refresher required**

#### Finance Onboarding (Referenced in SOP-003)
Complete the Finance-specific onboarding program covering:
- Company financial policies and procedures
- Ethics and compliance requirements
- Vendor management protocols
- Payment processing standards

#### Invoice Processing Certification
After completing security and finance training:
- Shadow experienced processor for 5-10 invoices
- Complete hands-on certification test
- Demonstrate proficiency in:
  - Three-way matching
  - Approval routing
  - Troubleshooting common issues
  - Using ERP and workflow systems

### Prerequisites Before Training
Ensure you have:
- **System Access:** ERP credentials and AP module permissions (via SOP-002)
- **Manager Approval:** Training enrollment requires manager sign-off
- **Time Allocation:** ~8 hours for all modules

Once training is complete, you'll be authorized to process invoices independently.

**References:**
- Security Training SOP (SOP-003 v1.5.0)
- Invoice Processing SOP (SOP-001 v1.2.0)
- IT Access Provisioning SOP (SOP-002 v2.0.1)`,
          type: 'guide'
        };
      }

      // Default response
      return {
        text: `I found ${sources.length} relevant sources in the knowledge base. Based on your query "${query}", here's what I can tell you:

The SOP knowledge base contains information about this topic across multiple procedures. To give you the most accurate answer, I would:

1. Synthesize information from the ${sources.length} most relevant sections
2. Generate a step-by-step procedure tailored to your specific question
3. Include references to the source SOPs for further details

**Note:** This is a mock response. In production, an LLM would generate a comprehensive, contextually-aware answer based on the retrieved sources.

Try one of the example queries in the sidebar for a more detailed demonstration!`,
        type: 'info'
      };
    }

    // Add message to chat
    function addMessage(role, content) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;

      const now = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

      messageDiv.innerHTML = `
        <div class="message-content">${escapeHtml(content)}</div>
        <div class="message-meta">
          ${role === 'user' ? 'üë§ You' : 'ü§ñ SOP Assistant'} ‚Ä¢ ${now}
        </div>
      `;

      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Add assistant message with sources
    function addAssistantMessage(response, sources) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message assistant';

      const showSources = document.getElementById('showSources').checked;
      const now = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

      let html = `<div class="message-content">`;

      // Add generated content
      html += `
        <div class="generated-content">
          <div class="generated-header">
            <span>‚ú® Generated Response</span>
            <div class="action-buttons">
              <button class="btn btn-secondary" onclick="copyToClipboard(this)">üìã Copy</button>
              <button class="btn btn-primary" onclick="saveAsSOP()">üíæ Save as SOP</button>
            </div>
          </div>
          <div class="generated-text">${formatMarkdown(response.text)}</div>
        </div>
      `;

      // Add sources if enabled
      if (showSources && sources.length > 0) {
        html += `
          <div class="retrieved-sources">
            <div class="sources-header">
              üìö Retrieved Sources (${sources.length})
            </div>
        `;

        sources.forEach(source => {
          const scorePercent = Math.round(source.relevanceScore * 100);
          html += `
            <div class="source-item">
              <div class="source-header">
                <span class="source-title">${source.sopTitle} - ${source.section}</span>
                <span class="relevance-score">${scorePercent}% match</span>
              </div>
              <div class="source-excerpt">"${source.content.substring(0, 150)}..."</div>
              <a href="/public/sop-viewer.html?id=${source.sopId}" class="source-link">
                View full SOP ‚Üí
              </a>
            </div>
          `;
        });

        html += `</div>`;
      }

      html += `</div>`;
      html += `<div class="message-meta">ü§ñ SOP Assistant ‚Ä¢ ${now}</div>`;

      messageDiv.innerHTML = html;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Add loading message
    function addLoadingMessage() {
      const messagesContainer = document.getElementById('chatMessages');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'message assistant';
      loadingDiv.id = 'loadingMessage';

      loadingDiv.innerHTML = `
        <div class="message-content">
          <div class="loading-message">
            <span>Searching knowledge base and generating response</span>
            <div class="loading-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      `;

      messagesContainer.appendChild(loadingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Remove loading message
    function removeLoadingMessage() {
      const loadingMsg = document.getElementById('loadingMessage');
      if (loadingMsg) loadingMsg.remove();
    }

    // Format markdown to HTML
    function formatMarkdown(text) {
      return text
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h3>$1</h3>')
        .replace(/^# (.*$)/gim, '<h3>$1</h3>')
        .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/gim, '<em>$1</em>')
        .replace(/^- \[([ x])\] (.*$)/gim, '<li style="list-style: none;"><input type="checkbox" $1 disabled> $2</li>')
        .replace(/^- (.*$)/gim, '<li>$1</li>')
        .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/<li>/g, '</ul><ul><li>')
        .replace(/<\/li>\n<li>/g, '</li><li>')
        .replace(/<ul><\/ul>/g, '')
        .replace(/^(.*)$/gim, match => {
          if (!match.startsWith('<')) return `<p>${match}</p>`;
          return match;
        });
    }

    // Copy to clipboard
    function copyToClipboard(btn) {
      const content = btn.closest('.generated-content').querySelector('.generated-text').innerText;
      navigator.clipboard.writeText(content);

      const originalText = btn.innerHTML;
      btn.innerHTML = '‚úì Copied!';
      setTimeout(() => {
        btn.innerHTML = originalText;
      }, 2000);
    }

    // Save as SOP
    function saveAsSOP() {
      alert('This would open the SOP editor with the generated content pre-filled, ready for customization and saving.');
      // In production: redirect to editor with content
      // window.location.href = '/public/sop-viewer.html?mode=create&prefill=true';
    }

    // Utility functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Load knowledge base stats from API
    async function loadKBStats() {
      try {
        const response = await fetch('/api/assistant/health');
        const data = await response.json();

        const statsHtml = `
          üìö ${data.stats.totalEmbeddings} SOP sections indexed<br>
          ü§ñ RAG: ${data.services.vectorDB} mode<br>
          üí¨ LLM: ${data.services.llm} mode<br>
          ‚ö° Avg response: ${data.stats.avgResponseTime}<br>
          ‚ú® Status: ${data.status}
        `;

        document.getElementById('kb-stats').innerHTML = statsHtml;
      } catch (error) {
        document.getElementById('kb-stats').innerHTML = `
          ‚ö†Ô∏è Unable to load stats<br>
          üì° Check API connection
        `;
      }
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadKBStats();

      // Log API info
      console.log('%cü§ñ SOP Assistant - Production RAG API Active', 'color: #0052CC; font-weight: bold; font-size: 14px;');
      console.log('%cEndpoint: /api/assistant/query', 'color: #666;');
      console.log('%cVector DB: Mock (ready for Pinecone/Weaviate)', 'color: #666;');
      console.log('%cLLM: Mock (ready for OpenAI/Anthropic)', 'color: #666;');
    });
  </script>
</body>
</html>
