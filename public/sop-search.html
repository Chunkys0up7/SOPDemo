<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Search - SOP System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #0052CC 0%, #003d99 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .search-header {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .search-header h1 {
      color: #2d3748;
      font-size: 28px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .search-box-wrapper {
      position: relative;
      margin-bottom: 24px;
    }

    .search-box {
      width: 100%;
      padding: 18px 60px 18px 24px;
      border: 3px solid #e2e8f0;
      border-radius: 12px;
      font-size: 17px;
      transition: all 0.2s;
    }

    .search-box:focus {
      outline: none;
      border-color: #0052CC;
      box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.1);
    }

    .search-icon {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 24px;
      color: #a0aec0;
      pointer-events: none;
    }

    .search-suggestions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .suggestion-chip {
      padding: 8px 16px;
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      font-size: 13px;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.2s;
    }

    .suggestion-chip:hover {
      background: #ebf4ff;
      border-color: #0052CC;
      color: #0052CC;
    }

    .main-content {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 30px;
    }

    .filters-panel {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      height: fit-content;
      position: sticky;
      top: 20px;
    }

    .filters-header {
      padding: 20px;
      border-bottom: 2px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .filters-header h2 {
      font-size: 18px;
      color: #2d3748;
    }

    .clear-filters {
      font-size: 13px;
      color: #0052CC;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .clear-filters:hover {
      text-decoration: underline;
    }

    .filter-section {
      padding: 20px;
      border-bottom: 1px solid #f7fafc;
    }

    .filter-section:last-child {
      border-bottom: none;
    }

    .filter-section h3 {
      font-size: 13px;
      text-transform: uppercase;
      color: #718096;
      font-weight: 700;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      cursor: pointer;
    }

    .filter-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .filter-option label {
      flex: 1;
      font-size: 14px;
      color: #4a5568;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .filter-count {
      font-size: 12px;
      color: #a0aec0;
      background: #f7fafc;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .date-range-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }

    .date-range-inputs input[type="date"] {
      padding: 8px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
    }

    .results-panel {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .results-header {
      padding: 20px 30px;
      border-bottom: 2px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .results-info {
      font-size: 15px;
      color: #4a5568;
    }

    .results-info strong {
      color: #2d3748;
      font-weight: 700;
    }

    .results-sort {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .results-sort label {
      font-size: 14px;
      color: #718096;
      font-weight: 600;
    }

    .results-sort select {
      padding: 8px 32px 8px 12px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234a5568' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    .results-list {
      padding: 30px;
      display: grid;
      gap: 20px;
    }

    .result-card {
      padding: 24px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .result-card:hover {
      border-color: #0052CC;
      box-shadow: 0 4px 12px rgba(0, 82, 204, 0.15);
      transform: translateY(-2px);
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .result-title {
      font-size: 18px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 6px;
    }

    .result-id {
      font-size: 13px;
      color: #a0aec0;
      font-weight: 600;
    }

    .result-version {
      background: #e2e8f0;
      color: #4a5568;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
    }

    .result-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #718096;
    }

    .result-snippet {
      font-size: 14px;
      color: #4a5568;
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .result-snippet mark {
      background: #fef5e7;
      padding: 2px 4px;
      border-radius: 3px;
      font-weight: 600;
    }

    .result-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tag {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .tag-department {
      background: #e0e7ff;
      color: #4f46e5;
    }

    .tag-category {
      background: #d1fae5;
      color: #065f46;
    }

    .tag-status {
      background: #fee2e2;
      color: #991b1b;
    }

    .tag-status.active {
      background: #d1fae5;
      color: #065f46;
    }

    .empty-state {
      text-align: center;
      padding: 80px 30px;
      color: #a0aec0;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      font-size: 20px;
      color: #4a5568;
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
    }

    .saved-searches {
      padding: 16px 20px;
      background: #f7fafc;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .saved-search-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 13px;
      color: #4a5568;
      cursor: pointer;
    }

    .saved-search-item:hover {
      color: #0052CC;
    }

    .saved-search-delete {
      background: none;
      border: none;
      color: #a0aec0;
      cursor: pointer;
      padding: 4px;
    }

    .saved-search-delete:hover {
      color: #ef4444;
    }

    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      .filters-panel {
        position: static;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Search Header -->
    <div class="search-header">
      <h1>üîç Advanced Search</h1>

      <div class="search-box-wrapper">
        <input type="text"
               class="search-box"
               id="searchInput"
               placeholder="Search SOPs by title, content, keywords..."
               oninput="performSearch()">
        <span class="search-icon">üîç</span>
      </div>

      <div class="search-suggestions">
        <span style="font-size: 13px; color: #718096; font-weight: 600; margin-right: 8px;">Quick searches:</span>
        <button class="suggestion-chip" onclick="quickSearch('AUS processing')">AUS processing</button>
        <button class="suggestion-chip" onclick="quickSearch('wire transfer')">Wire transfer</button>
        <button class="suggestion-chip" onclick="quickSearch('TRID compliance')">TRID compliance</button>
        <button class="suggestion-chip" onclick="quickSearch('income documentation')">Income documentation</button>
        <button class="suggestion-chip" onclick="quickSearch('underwriting')">Underwriting</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Filters Panel -->
      <div class="filters-panel">
        <div class="filters-header">
          <h2>üéØ Filters</h2>
          <button class="clear-filters" onclick="clearAllFilters()">Clear All</button>
        </div>

        <!-- Saved Searches -->
        <div class="saved-searches">
          <h3 style="font-size: 12px; color: #718096; margin-bottom: 8px; text-transform: uppercase; font-weight: 700;">üíæ Saved Searches</h3>
          <div class="saved-search-item" onclick="loadSavedSearch('my-department')">
            <span>üìÅ My Department</span>
            <button class="saved-search-delete" onclick="deleteSavedSearch(event, 'my-department')">‚úï</button>
          </div>
          <div class="saved-search-item" onclick="loadSavedSearch('recent-updates')">
            <span>üïê Updated This Week</span>
            <button class="saved-search-delete" onclick="deleteSavedSearch(event, 'recent-updates')">‚úï</button>
          </div>
        </div>

        <!-- Department Filter -->
        <div class="filter-section">
          <h3>Department</h3>
          <div class="filter-option">
            <input type="checkbox" id="dept-it" onchange="applyFilters()">
            <label for="dept-it">
              <span>üíª IT</span>
              <span class="filter-count" id="count-dept-it">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="dept-hr" onchange="applyFilters()">
            <label for="dept-hr">
              <span>üë• HR</span>
              <span class="filter-count" id="count-dept-hr">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="dept-finance" onchange="applyFilters()">
            <label for="dept-finance">
              <span>üí∞ Finance</span>
              <span class="filter-count" id="count-dept-finance">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="dept-operations" onchange="applyFilters()">
            <label for="dept-operations">
              <span>‚öôÔ∏è Operations</span>
              <span class="filter-count" id="count-dept-operations">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="dept-compliance" onchange="applyFilters()">
            <label for="dept-compliance">
              <span>‚öñÔ∏è Compliance</span>
              <span class="filter-count" id="count-dept-compliance">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="dept-security" onchange="applyFilters()">
            <label for="dept-security">
              <span>üîí Security</span>
              <span class="filter-count" id="count-dept-security">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="dept-multi-department" onchange="applyFilters()">
            <label for="dept-multi-department">
              <span>üè¢ Multi-Department</span>
              <span class="filter-count" id="count-dept-multi-department">0</span>
            </label>
          </div>
        </div>

        <!-- Process Category Filter -->
        <div class="filter-section">
          <h3>Process Category</h3>
          <div class="filter-option">
            <input type="checkbox" id="cat-troubleshooting" onchange="applyFilters()">
            <label for="cat-troubleshooting">
              <span>Troubleshooting</span>
              <span class="filter-count" id="count-cat-troubleshooting">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="cat-compliance-audit" onchange="applyFilters()">
            <label for="cat-compliance-audit">
              <span>Compliance & Audit</span>
              <span class="filter-count" id="count-cat-compliance-audit">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="cat-system-config" onchange="applyFilters()">
            <label for="cat-system-config">
              <span>System Configuration</span>
              <span class="filter-count" id="count-cat-system-config">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="cat-maintenance" onchange="applyFilters()">
            <label for="cat-maintenance">
              <span>Maintenance & Updates</span>
              <span class="filter-count" id="count-cat-maintenance">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="cat-risk-mgmt" onchange="applyFilters()">
            <label for="cat-risk-mgmt">
              <span>Risk Management</span>
              <span class="filter-count" id="count-cat-risk-mgmt">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="cat-training" onchange="applyFilters()">
            <label for="cat-training">
              <span>Training & Onboarding</span>
              <span class="filter-count" id="count-cat-training">0</span>
            </label>
          </div>
        </div>

        <!-- Complexity Filter -->
        <div class="filter-section">
          <h3>Complexity</h3>
          <div class="filter-option">
            <input type="checkbox" id="complex-basic" onchange="applyFilters()">
            <label for="complex-basic">
              <span>‚≠ê Basic</span>
              <span class="filter-count" id="count-complex-basic">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="complex-intermediate" onchange="applyFilters()">
            <label for="complex-intermediate">
              <span>‚≠ê‚≠ê Intermediate</span>
              <span class="filter-count" id="count-complex-intermediate">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="complex-advanced" onchange="applyFilters()">
            <label for="complex-advanced">
              <span>‚≠ê‚≠ê‚≠ê Advanced</span>
              <span class="filter-count" id="count-complex-advanced">0</span>
            </label>
          </div>
        </div>

        <!-- Audience Filter -->
        <div class="filter-section">
          <h3>Audience</h3>
          <div class="filter-option">
            <input type="checkbox" id="aud-individual" onchange="applyFilters()">
            <label for="aud-individual">
              <span>Individual Contributor</span>
              <span class="filter-count" id="count-aud-individual">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="aud-technician" onchange="applyFilters()">
            <label for="aud-technician">
              <span>Technician/Specialist</span>
              <span class="filter-count" id="count-aud-technician">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="aud-manager" onchange="applyFilters()">
            <label for="aud-manager">
              <span>Manager/Supervisor</span>
              <span class="filter-count" id="count-aud-manager">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="aud-executive" onchange="applyFilters()">
            <label for="aud-executive">
              <span>C-Level Executive</span>
              <span class="filter-count" id="count-aud-executive">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="aud-customer" onchange="applyFilters()">
            <label for="aud-customer">
              <span>Customer/External User</span>
              <span class="filter-count" id="count-aud-customer">0</span>
            </label>
          </div>
        </div>

        <!-- Compliance Frameworks Filter -->
        <div class="filter-section">
          <h3>Compliance Frameworks</h3>
          <div class="filter-option">
            <input type="checkbox" id="comp-sox" onchange="applyFilters()">
            <label for="comp-sox">
              <span>SOX</span>
              <span class="filter-count" id="count-comp-sox">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="comp-hipaa" onchange="applyFilters()">
            <label for="comp-hipaa">
              <span>HIPAA</span>
              <span class="filter-count" id="count-comp-hipaa">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="comp-soc2" onchange="applyFilters()">
            <label for="comp-soc2">
              <span>SOC 2</span>
              <span class="filter-count" id="count-comp-soc2">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="comp-iso9001" onchange="applyFilters()">
            <label for="comp-iso9001">
              <span>ISO 9001</span>
              <span class="filter-count" id="count-comp-iso9001">0</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="comp-gdpr" onchange="applyFilters()">
            <label for="comp-gdpr">
              <span>GDPR</span>
              <span class="filter-count" id="count-comp-gdpr">0</span>
            </label>
          </div>
        </div>

        <!-- Status Filter -->
        <div class="filter-section">
          <h3>Status</h3>
          <div class="filter-option">
            <input type="checkbox" id="status-active" checked onchange="applyFilters()">
            <label for="status-active">
              <span>‚úÖ Active</span>
              <span class="filter-count">14</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="status-draft" onchange="applyFilters()">
            <label for="status-draft">
              <span>üìù Draft</span>
              <span class="filter-count">2</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="status-archived" onchange="applyFilters()">
            <label for="status-archived">
              <span>üì¶ Archived</span>
              <span class="filter-count">3</span>
            </label>
          </div>
        </div>

        <!-- Date Range Filter -->
        <div class="filter-section">
          <h3>Last Updated</h3>
          <div class="filter-option">
            <input type="checkbox" id="date-week" onchange="applyFilters()">
            <label for="date-week">
              <span>Past Week</span>
              <span class="filter-count">3</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="date-month" onchange="applyFilters()">
            <label for="date-month">
              <span>Past Month</span>
              <span class="filter-count">7</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="date-quarter" onchange="applyFilters()">
            <label for="date-quarter">
              <span>Past Quarter</span>
              <span class="filter-count">12</span>
            </label>
          </div>
          <div class="date-range-inputs">
            <input type="date" id="dateFrom" onchange="applyFilters()" placeholder="From">
            <input type="date" id="dateTo" onchange="applyFilters()" placeholder="To">
          </div>
        </div>

        <!-- Owner Filter -->
        <div class="filter-section">
          <h3>Owner</h3>
          <div class="filter-option">
            <input type="checkbox" id="owner-me" onchange="applyFilters()">
            <label for="owner-me">
              <span>üë§ My SOPs</span>
              <span class="filter-count">5</span>
            </label>
          </div>
          <div class="filter-option">
            <input type="checkbox" id="owner-my-team" onchange="applyFilters()">
            <label for="owner-my-team">
              <span>üë• My Team</span>
              <span class="filter-count">12</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Results Panel -->
      <div class="results-panel">
        <div class="results-header">
          <div class="results-info">
            <strong id="resultCount">15</strong> SOPs found
          </div>
          <div class="results-sort">
            <label>Sort by:</label>
            <select id="sortSelect" onchange="sortResults()">
              <option value="relevance">Relevance</option>
              <option value="title">Title (A-Z)</option>
              <option value="updated">Recently Updated</option>
              <option value="popular">Most Popular</option>
            </select>
          </div>
        </div>

        <div class="results-list" id="resultsList">
          <!-- Results will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <script>
    let allSOPs = [];
    let allComponents = [];
    let filteredResults = [];
    let currentSearchQuery = '';

    // Load graph data
    async function loadGraphData() {
      try {
        const response = await fetch('/graph/sop-graph.json');
        const graphData = await response.json();

        // Extract all nodes (SOPs, atoms, molecules, organisms)
        allComponents = Object.values(graphData.nodes || {});

        // Filter to only include items with searchable metadata
        allSOPs = allComponents.filter(node =>
          node.type === 'sop' || node.type === 'atom' || node.type === 'molecule' || node.type === 'organism'
        ).map(node => {
          // Normalize data structure
          return {
            id: node.id,
            type: node.type,
            title: node.title,
            department: node.department || node.owner || 'N/A',
            processCategory: node.processCategory || 'N/A',
            complexity: node.complexity || 'N/A',
            audience: node.audience || [],
            status: node.status || 'active',
            version: node.version || '1.0.0',
            lastUpdated: node.lastReviewed || node.metadata?.lastReviewed || '2025-01-01',
            owner: node.owner || 'N/A',
            maintainer: node.maintainer || node.owner || 'N/A',
            approver: node.approver || node.metadata?.approver || 'N/A',
            usage: Math.floor(Math.random() * 1000) + 100, // Mock usage data
            snippet: `${node.title} - ${node.type}`,
            tags: node.tags || [],
            keywords: node.keywords || [],
            complianceFrameworks: node.complianceFrameworks || [],
            reusableIn: node.reusableIn || [],
            variationCount: node.variationCount || 1
          };
        });

        filteredResults = [...allSOPs];
        updateFilterCounts();
        renderResults(filteredResults);

        console.log(`‚úÖ Loaded ${allSOPs.length} components from graph`);
      } catch (error) {
        console.error('Error loading graph data:', error);
        allSOPs = [];
        filteredResults = [];
        renderResults([]);
      }
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      loadGraphData();
    });

    function performSearch() {
      currentSearchQuery = document.getElementById('searchInput').value.toLowerCase();

      if (!currentSearchQuery) {
        filteredResults = [...allSOPs];
      } else {
        filteredResults = allSOPs.filter(sop => {
          return sop.title.toLowerCase().includes(currentSearchQuery) ||
                 sop.snippet.toLowerCase().includes(currentSearchQuery) ||
                 sop.tags.some(tag => tag.toLowerCase().includes(currentSearchQuery)) ||
                 sop.keywords.some(kw => kw.toLowerCase().includes(currentSearchQuery)) ||
                 sop.department.toLowerCase().includes(currentSearchQuery) ||
                 sop.processCategory.toLowerCase().includes(currentSearchQuery) ||
                 sop.id.toLowerCase().includes(currentSearchQuery);
        });
      }

      applyFilters();
    }

    function applyFilters() {
      let results = currentSearchQuery ? filteredResults : [...allSOPs];

      // Department filters
      const deptFilters = [];
      if (document.getElementById('dept-it')?.checked) deptFilters.push('IT');
      if (document.getElementById('dept-hr')?.checked) deptFilters.push('HR');
      if (document.getElementById('dept-finance')?.checked) deptFilters.push('Finance');
      if (document.getElementById('dept-operations')?.checked) deptFilters.push('Operations');
      if (document.getElementById('dept-compliance')?.checked) deptFilters.push('Compliance');
      if (document.getElementById('dept-security')?.checked) deptFilters.push('Security');
      if (document.getElementById('dept-multi-department')?.checked) deptFilters.push('Multi-Department');

      if (deptFilters.length > 0) {
        results = results.filter(sop => deptFilters.includes(sop.department));
      }

      // Process Category filters
      const catFilters = [];
      if (document.getElementById('cat-troubleshooting')?.checked) catFilters.push('Troubleshooting');
      if (document.getElementById('cat-compliance-audit')?.checked) catFilters.push('Compliance & Audit');
      if (document.getElementById('cat-system-config')?.checked) catFilters.push('System Configuration');
      if (document.getElementById('cat-maintenance')?.checked) catFilters.push('Maintenance & Updates');
      if (document.getElementById('cat-risk-mgmt')?.checked) catFilters.push('Risk Management');
      if (document.getElementById('cat-training')?.checked) catFilters.push('Training & Onboarding');

      if (catFilters.length > 0) {
        results = results.filter(sop => catFilters.includes(sop.processCategory));
      }

      // Complexity filters
      const complexFilters = [];
      if (document.getElementById('complex-basic')?.checked) complexFilters.push('Basic');
      if (document.getElementById('complex-intermediate')?.checked) complexFilters.push('Intermediate');
      if (document.getElementById('complex-advanced')?.checked) complexFilters.push('Advanced');

      if (complexFilters.length > 0) {
        results = results.filter(sop => complexFilters.includes(sop.complexity));
      }

      // Audience filters
      const audFilters = [];
      if (document.getElementById('aud-individual')?.checked) audFilters.push('Individual Contributor');
      if (document.getElementById('aud-technician')?.checked) audFilters.push('Technician/Specialist');
      if (document.getElementById('aud-manager')?.checked) audFilters.push('Manager/Supervisor');
      if (document.getElementById('aud-executive')?.checked) audFilters.push('C-Level Executive');
      if (document.getElementById('aud-customer')?.checked) audFilters.push('Customer/External User');

      if (audFilters.length > 0) {
        results = results.filter(sop => {
          if (!sop.audience || sop.audience.length === 0) return false;
          return audFilters.some(filter => sop.audience.includes(filter));
        });
      }

      // Compliance Framework filters
      const compFilters = [];
      if (document.getElementById('comp-sox')?.checked) compFilters.push('SOX');
      if (document.getElementById('comp-hipaa')?.checked) compFilters.push('HIPAA');
      if (document.getElementById('comp-soc2')?.checked) compFilters.push('SOC 2');
      if (document.getElementById('comp-iso9001')?.checked) compFilters.push('ISO 9001');
      if (document.getElementById('comp-gdpr')?.checked) compFilters.push('GDPR');

      if (compFilters.length > 0) {
        results = results.filter(sop => {
          if (!sop.complianceFrameworks || sop.complianceFrameworks.length === 0) return false;
          return compFilters.some(filter => sop.complianceFrameworks.includes(filter));
        });
      }

      // Status filter
      if (!document.getElementById('status-active')?.checked) {
        results = results.filter(sop => sop.status !== 'active');
      }

      // Owner filters
      if (document.getElementById('owner-me')?.checked) {
        // In production: filter by current user
        results = results.filter(sop => sop.owner === 'IT Department' || sop.owner === 'Sarah Johnson');
      }

      filteredResults = results;
      updateFilterCounts();
      renderResults(results);
    }

    // Update filter counts based on current data
    function updateFilterCounts() {
      const data = allSOPs;

      // Count by department
      const deptCounts = {};
      data.forEach(sop => {
        const dept = sop.department;
        deptCounts[dept] = (deptCounts[dept] || 0) + 1;
      });

      document.getElementById('count-dept-it').textContent = deptCounts['IT'] || 0;
      document.getElementById('count-dept-hr').textContent = deptCounts['HR'] || 0;
      document.getElementById('count-dept-finance').textContent = deptCounts['Finance'] || 0;
      document.getElementById('count-dept-operations').textContent = deptCounts['Operations'] || 0;
      document.getElementById('count-dept-compliance').textContent = deptCounts['Compliance'] || 0;
      document.getElementById('count-dept-security').textContent = deptCounts['Security'] || 0;
      document.getElementById('count-dept-multi-department').textContent = deptCounts['Multi-Department'] || 0;

      // Count by process category
      const catCounts = {};
      data.forEach(sop => {
        const cat = sop.processCategory;
        catCounts[cat] = (catCounts[cat] || 0) + 1;
      });

      document.getElementById('count-cat-troubleshooting').textContent = catCounts['Troubleshooting'] || 0;
      document.getElementById('count-cat-compliance-audit').textContent = catCounts['Compliance & Audit'] || 0;
      document.getElementById('count-cat-system-config').textContent = catCounts['System Configuration'] || 0;
      document.getElementById('count-cat-maintenance').textContent = catCounts['Maintenance & Updates'] || 0;
      document.getElementById('count-cat-risk-mgmt').textContent = catCounts['Risk Management'] || 0;
      document.getElementById('count-cat-training').textContent = catCounts['Training & Onboarding'] || 0;

      // Count by complexity
      const complexCounts = {};
      data.forEach(sop => {
        const complex = sop.complexity;
        complexCounts[complex] = (complexCounts[complex] || 0) + 1;
      });

      document.getElementById('count-complex-basic').textContent = complexCounts['Basic'] || 0;
      document.getElementById('count-complex-intermediate').textContent = complexCounts['Intermediate'] || 0;
      document.getElementById('count-complex-advanced').textContent = complexCounts['Advanced'] || 0;

      // Count by audience (counts items that include this audience)
      const audCounts = {};
      data.forEach(sop => {
        if (sop.audience && Array.isArray(sop.audience)) {
          sop.audience.forEach(aud => {
            audCounts[aud] = (audCounts[aud] || 0) + 1;
          });
        }
      });

      document.getElementById('count-aud-individual').textContent = audCounts['Individual Contributor'] || 0;
      document.getElementById('count-aud-technician').textContent = audCounts['Technician/Specialist'] || 0;
      document.getElementById('count-aud-manager').textContent = audCounts['Manager/Supervisor'] || 0;
      document.getElementById('count-aud-executive').textContent = audCounts['C-Level Executive'] || 0;
      document.getElementById('count-aud-customer').textContent = audCounts['Customer/External User'] || 0;

      // Count by compliance frameworks
      const compCounts = {};
      data.forEach(sop => {
        if (sop.complianceFrameworks && Array.isArray(sop.complianceFrameworks)) {
          sop.complianceFrameworks.forEach(comp => {
            compCounts[comp] = (compCounts[comp] || 0) + 1;
          });
        }
      });

      document.getElementById('count-comp-sox').textContent = compCounts['SOX'] || 0;
      document.getElementById('count-comp-hipaa').textContent = compCounts['HIPAA'] || 0;
      document.getElementById('count-comp-soc2').textContent = compCounts['SOC 2'] || 0;
      document.getElementById('count-comp-iso9001').textContent = compCounts['ISO 9001'] || 0;
      document.getElementById('count-comp-gdpr').textContent = compCounts['GDPR'] || 0;
    }

    function renderResults(results) {
      const resultsList = document.getElementById('resultsList');
      const resultCount = document.getElementById('resultCount');

      resultCount.textContent = results.length;

      if (results.length === 0) {
        resultsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <h3>No SOPs Found</h3>
            <p>Try adjusting your search terms or filters</p>
          </div>
        `;
        return;
      }

      resultsList.innerHTML = results.map(sop => {
        const snippet = highlightSearchTerms(sop.snippet, currentSearchQuery);

        // Build tags display
        let tagsHTML = `<span class="tag tag-department">${sop.type.toUpperCase()}</span>`;

        if (sop.department && sop.department !== 'N/A') {
          tagsHTML += `<span class="tag tag-department">${sop.department}</span>`;
        }

        if (sop.processCategory && sop.processCategory !== 'N/A') {
          tagsHTML += `<span class="tag tag-category">${sop.processCategory}</span>`;
        }

        if (sop.complexity && sop.complexity !== 'N/A') {
          const stars = { 'Basic': '‚≠ê', 'Intermediate': '‚≠ê‚≠ê', 'Advanced': '‚≠ê‚≠ê‚≠ê' };
          tagsHTML += `<span class="tag tag-category">${stars[sop.complexity] || ''} ${sop.complexity}</span>`;
        }

        if (sop.complianceFrameworks && sop.complianceFrameworks.length > 0) {
          sop.complianceFrameworks.slice(0, 3).forEach(fw => {
            tagsHTML += `<span class="tag tag-status">${fw}</span>`;
          });
        }

        return `
          <div class="result-card" onclick="openSOP('${sop.id}')">
            <div class="result-header">
              <div>
                <div class="result-title">${sop.title}</div>
                <div class="result-id">${sop.id.toUpperCase()}</div>
              </div>
              <span class="result-version">v${sop.version}</span>
            </div>

            <div class="result-meta">
              <span class="meta-item">
                <span>üìÖ</span>
                Updated ${formatDate(sop.lastUpdated)}
              </span>
              <span class="meta-item">
                <span>üë§</span>
                ${sop.owner}
              </span>
              <span class="meta-item">
                <span>‚ôªÔ∏è</span>
                Used in ${(sop.reusableIn || []).length} places
              </span>
              ${sop.audience && sop.audience.length > 0 ? `
              <span class="meta-item">
                <span>üë•</span>
                ${sop.audience[0]}${sop.audience.length > 1 ? ` +${sop.audience.length - 1}` : ''}
              </span>
              ` : ''}
            </div>

            <div class="result-snippet">
              ${snippet}
            </div>

            <div class="result-tags">
              ${tagsHTML}
            </div>
          </div>
        `;
      }).join('');
    }

    function highlightSearchTerms(text, query) {
      if (!query) return text;

      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return 'today';
      if (diffDays === 1) return 'yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;

      return date.toLocaleDateString();
    }

    function quickSearch(query) {
      document.getElementById('searchInput').value = query;
      performSearch();
    }

    function clearAllFilters() {
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (cb.id === 'status-active') {
          cb.checked = true;
        } else {
          cb.checked = false;
        }
      });

      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';

      applyFilters();
    }

    function sortResults() {
      const sortBy = document.getElementById('sortSelect').value;

      switch (sortBy) {
        case 'title':
          filteredResults.sort((a, b) => a.title.localeCompare(b.title));
          break;
        case 'updated':
          filteredResults.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
          break;
        case 'popular':
          filteredResults.sort((a, b) => b.usage - a.usage);
          break;
        default: // relevance
          // Already sorted by relevance from search
          break;
      }

      renderResults(filteredResults);
    }

    function openSOP(sopId) {
      window.location.href = `sop-viewer.html?sop=${sopId}`;
    }

    function loadSavedSearch(searchId) {
      if (searchId === 'my-department') {
        document.getElementById('dept-underwriting').checked = true;
      } else if (searchId === 'recent-updates') {
        document.getElementById('date-week').checked = true;
      }

      applyFilters();
    }

    function deleteSavedSearch(event, searchId) {
      event.stopPropagation();
      alert(`Delete saved search: ${searchId}?\n(Feature coming soon)`);
    }
  </script>
</body>
</html>
