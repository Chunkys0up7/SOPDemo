<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOP Training & Certification - SOP System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #0052CC 0%, #003d99 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .header h1 {
      color: #2d3748;
      font-size: 28px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header p {
      color: #718096;
      font-size: 15px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-top: 20px;
      border-bottom: 2px solid #e2e8f0;
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      font-size: 15px;
      font-weight: 600;
      color: #718096;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }

    .tab:hover {
      color: #4a5568;
    }

    .tab.active {
      color: #0052CC;
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: #0052CC;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .card h2 {
      font-size: 22px;
      color: #2d3748;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .quiz-generator {
      display: grid;
      gap: 24px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
    }

    .form-group select,
    .form-group input[type="number"] {
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.2s;
    }

    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #0052CC;
    }

    .form-group-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-item label {
      font-size: 14px;
      color: #4a5568;
      cursor: pointer;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .btn-primary {
      background: #0052CC;
      color: white;
    }

    .btn-primary:hover {
      background: #003d99;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }

    .btn-secondary:hover {
      background: #cbd5e0;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .quiz-preview {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 2px solid #e2e8f0;
    }

    .question-card {
      background: #f7fafc;
      padding: 24px;
      border-radius: 10px;
      margin-bottom: 24px;
      border-left: 4px solid #0052CC;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .question-number {
      background: #0052CC;
      color: white;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 700;
    }

    .question-difficulty {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .difficulty-beginner {
      background: #d1fae5;
      color: #065f46;
    }

    .difficulty-intermediate {
      background: #fef3c7;
      color: #92400e;
    }

    .difficulty-advanced {
      background: #fee2e2;
      color: #991b1b;
    }

    .question-text {
      font-size: 16px;
      color: #2d3748;
      font-weight: 600;
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .answer-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .answer-option {
      padding: 14px 18px;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .answer-option:hover {
      border-color: #cbd5e0;
    }

    .answer-option input[type="radio"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .answer-option label {
      flex: 1;
      font-size: 15px;
      color: #4a5568;
      cursor: pointer;
    }

    .answer-option.correct {
      border-color: #48bb78;
      background: #f0fdf4;
    }

    .answer-option.incorrect {
      border-color: #ef4444;
      background: #fef2f2;
    }

    .answer-option.selected {
      border-color: #0052CC;
      background: #ebf4ff;
    }

    .explanation {
      margin-top: 16px;
      padding: 16px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid #48bb78;
    }

    .explanation-title {
      font-size: 13px;
      font-weight: 700;
      color: #065f46;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .explanation-text {
      font-size: 14px;
      color: #4a5568;
      line-height: 1.6;
    }

    .quiz-results {
      background: linear-gradient(135deg, #0052CC 0%, #003d99 100%);
      color: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
    }

    .results-score {
      font-size: 64px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .results-label {
      font-size: 18px;
      opacity: 0.9;
      margin-bottom: 24px;
    }

    .results-message {
      font-size: 16px;
      opacity: 0.95;
      margin-bottom: 32px;
    }

    .results-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #f7fafc;
      padding: 24px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 13px;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .progress-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #0052CC 0%, #003d99 100%);
      border-radius: 4px;
      transition: width 0.3s;
    }

    .certification-list {
      display: grid;
      gap: 16px;
    }

    .cert-card {
      background: #f7fafc;
      padding: 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 20px;
      border-left: 4px solid #48bb78;
    }

    .cert-icon {
      font-size: 48px;
    }

    .cert-details {
      flex: 1;
    }

    .cert-title {
      font-size: 18px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 4px;
    }

    .cert-meta {
      font-size: 13px;
      color: #718096;
    }

    .cert-status {
      padding: 6px 16px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .cert-status.active {
      background: #d1fae5;
      color: #065f46;
    }

    .cert-status.expired {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üéì SOP Training & Certification</h1>
      <p>AI-powered training modules and compliance certification</p>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('generator')">üìù Quiz Generator</button>
        <button class="tab" onclick="switchTab('my-progress')">üìä My Progress</button>
        <button class="tab" onclick="switchTab('certifications')">üèÜ Certifications</button>
        <button class="tab" onclick="switchTab('team')">üë• Team Dashboard</button>
      </div>
    </div>

    <!-- Tab: Quiz Generator -->
    <div id="tab-generator" class="tab-content active">
      <div class="card">
        <h2>ü§ñ AI-Powered Quiz Generator</h2>

        <div class="quiz-generator">
          <div class="form-group">
            <label>Select SOP for Training</label>
            <select id="sopSelect">
              <option value="">Choose an SOP...</option>
              <option value="sop-mf-001">SOP-MF-001: Conventional Loan Processing</option>
              <option value="sop-mf-002" selected>SOP-MF-002: AUS Processing</option>
              <option value="sop-mf-003">SOP-MF-003: FHA Underwriting Standards</option>
              <option value="sop-mf-004">SOP-MF-004: Clear to Close Verification</option>
              <option value="sop-mf-005">SOP-MF-005: Wire Transfer Security</option>
              <option value="sop-mf-008">SOP-MF-008: Income Documentation</option>
              <option value="sop-mf-010">SOP-MF-010: TRID Compliance</option>
            </select>
          </div>

          <div class="form-group-row">
            <div class="form-group">
              <label>Difficulty Level</label>
              <select id="difficultySelect">
                <option value="beginner">Beginner (Basic concepts)</option>
                <option value="intermediate" selected>Intermediate (Standard workflow)</option>
                <option value="advanced">Advanced (Complex scenarios)</option>
                <option value="mixed">Mixed (All levels)</option>
              </select>
            </div>

            <div class="form-group">
              <label>Number of Questions</label>
              <input type="number" id="questionCount" value="10" min="5" max="50">
            </div>
          </div>

          <div class="form-group">
            <label>Question Types</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="type-mc" checked>
                <label for="type-mc">Multiple Choice</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="type-tf" checked>
                <label for="type-tf">True/False</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="type-scenario" checked>
                <label for="type-scenario">Scenario-Based</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="type-fill">
                <label for="type-fill">Fill in the Blank</label>
              </div>
            </div>
          </div>

          <div style="display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="generateQuiz()">
              ‚ú® Generate Quiz
            </button>
            <button class="btn btn-secondary" onclick="previewSOP()">
              üëÅÔ∏è Preview SOP
            </button>
          </div>
        </div>

        <div id="quizPreview"></div>
      </div>
    </div>

    <!-- Tab: My Progress -->
    <div id="tab-my-progress" class="tab-content">
      <div class="card">
        <h2>üìä My Training Progress</h2>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">23</div>
            <div class="stat-label">Quizzes Completed</div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 92%;"></div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-value">87%</div>
            <div class="stat-label">Average Score</div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 87%;"></div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-value">15</div>
            <div class="stat-label">SOPs Certified</div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 75%;"></div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-value">4.2h</div>
            <div class="stat-label">Training Time</div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 60%;"></div>
            </div>
          </div>
        </div>

        <h3 style="font-size: 18px; color: #2d3748; margin-bottom: 16px;">Recent Quiz Results</h3>

        <div style="display: grid; gap: 12px;">
          <div style="background: #f7fafc; padding: 20px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">AUS Processing (SOP-MF-002)</div>
              <div style="font-size: 13px; color: #718096;">Completed Nov 14, 2025 ‚Ä¢ 10 questions ‚Ä¢ Intermediate</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 28px; font-weight: 700; color: #48bb78;">92%</div>
              <div style="font-size: 12px; color: #718096;">9/10 correct</div>
            </div>
          </div>

          <div style="background: #f7fafc; padding: 20px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">Wire Transfer Security (SOP-MF-005)</div>
              <div style="font-size: 13px; color: #718096;">Completed Nov 12, 2025 ‚Ä¢ 15 questions ‚Ä¢ Advanced</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 28px; font-weight: 700; color: #48bb78;">87%</div>
              <div style="font-size: 12px; color: #718096;">13/15 correct</div>
            </div>
          </div>

          <div style="background: #f7fafc; padding: 20px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">TRID Compliance (SOP-MF-010)</div>
              <div style="font-size: 13px; color: #718096;">Completed Nov 10, 2025 ‚Ä¢ 12 questions ‚Ä¢ Intermediate</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 28px; font-weight: 700; color: #f59e0b;">75%</div>
              <div style="font-size: 12px; color: #718096;">9/12 correct</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Certifications -->
    <div id="tab-certifications" class="tab-content">
      <div class="card">
        <h2>üèÜ My Certifications</h2>

        <div class="certification-list">
          <div class="cert-card">
            <div class="cert-icon">üèÜ</div>
            <div class="cert-details">
              <div class="cert-title">Underwriting Department Certification</div>
              <div class="cert-meta">Issued: Sep 15, 2025 ‚Ä¢ Expires: Sep 15, 2026 ‚Ä¢ 12 SOPs</div>
            </div>
            <div class="cert-status active">‚úì Active</div>
            <button class="btn btn-secondary" onclick="downloadCert('underwriting')">üìÑ Download</button>
          </div>

          <div class="cert-card">
            <div class="cert-icon">üèÜ</div>
            <div class="cert-details">
              <div class="cert-title">TRID Compliance Specialist</div>
              <div class="cert-meta">Issued: Aug 3, 2025 ‚Ä¢ Expires: Aug 3, 2026 ‚Ä¢ 3 SOPs</div>
            </div>
            <div class="cert-status active">‚úì Active</div>
            <button class="btn btn-secondary" onclick="downloadCert('trid')">üìÑ Download</button>
          </div>

          <div class="cert-card" style="border-left-color: #ef4444;">
            <div class="cert-icon">‚ö†Ô∏è</div>
            <div class="cert-details">
              <div class="cert-title">Fraud Prevention Certification</div>
              <div class="cert-meta">Issued: Jan 12, 2025 ‚Ä¢ Expired: Jan 12, 2026 ‚Ä¢ 2 SOPs</div>
            </div>
            <div class="cert-status expired">‚ö† Expired</div>
            <button class="btn btn-primary" onclick="renewCert('fraud')">üîÑ Renew</button>
          </div>
        </div>

        <div style="margin-top: 30px; padding: 24px; background: #ebf4ff; border-radius: 10px; border-left: 4px solid #0052CC;">
          <div style="font-size: 16px; font-weight: 700; color: #2d3748; margin-bottom: 8px;">
            üí° Available Certifications
          </div>
          <div style="font-size: 14px; color: #4a5568; line-height: 1.6;">
            Complete training quizzes to earn certifications:<br>
            ‚Ä¢ FHA Underwriting Specialist (5 SOPs remaining)<br>
            ‚Ä¢ Loan Processing Expert (3 SOPs remaining)<br>
            ‚Ä¢ Quality Control Certification (7 SOPs remaining)
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Team Dashboard -->
    <div id="tab-team" class="tab-content">
      <div class="card">
        <h2>üë• Team Training Dashboard</h2>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">89%</div>
            <div class="stat-label">Team Compliance</div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 89%;"></div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-value">47</div>
            <div class="stat-label">Team Members</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">342</div>
            <div class="stat-label">Quizzes This Month</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">82%</div>
            <div class="stat-label">Avg Team Score</div>
          </div>
        </div>

        <h3 style="font-size: 18px; color: #2d3748; margin-bottom: 16px;">Department Compliance Status</h3>

        <div style="display: grid; gap: 12px;">
          <div style="background: #f7fafc; padding: 20px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
              <div>
                <div style="font-weight: 700; color: #2d3748;">Processing Department</div>
                <div style="font-size: 13px; color: #718096;">15 members ‚Ä¢ 12 SOPs</div>
              </div>
              <div style="font-size: 24px; font-weight: 700; color: #48bb78;">94%</div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 94%;"></div>
            </div>
          </div>

          <div style="background: #f7fafc; padding: 20px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
              <div>
                <div style="font-weight: 700; color: #2d3748;">Underwriting Department</div>
                <div style="font-size: 13px; color: #718096;">18 members ‚Ä¢ 15 SOPs</div>
              </div>
              <div style="font-size: 24px; font-weight: 700; color: #48bb78;">91%</div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 91%;"></div>
            </div>
          </div>

          <div style="background: #f7fafc; padding: 20px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
              <div>
                <div style="font-weight: 700; color: #2d3748;">Closing Department</div>
                <div style="font-size: 13px; color: #718096;">14 members ‚Ä¢ 8 SOPs</div>
              </div>
              <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">78%</div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 78%;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentQuiz = null;
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let quizStartTime = null;

    // Mock quiz questions database
    const mockQuestions = {
      'sop-mf-002': [
        {
          id: 1,
          type: 'multiple-choice',
          difficulty: 'intermediate',
          question: 'What is the primary purpose of Desktop Underwriter (DU) in the AUS processing workflow?',
          options: [
            'To calculate monthly mortgage payments',
            'To automatically assess borrower eligibility and loan risk for Fannie Mae guidelines',
            'To generate appraisal reports',
            'To verify borrower employment history'
          ],
          correct: 1,
          explanation: 'Desktop Underwriter (DU) is Fannie Mae\'s automated underwriting system that evaluates loan files against Fannie Mae guidelines to provide risk assessment and eligibility determination. It analyzes credit, income, assets, and property data to generate findings.'
        },
        {
          id: 2,
          type: 'multiple-choice',
          difficulty: 'beginner',
          question: 'Before submitting a loan to AUS, which of the following is NOT a required document?',
          options: [
            'Complete 1003 Uniform Residential Loan Application',
            'Credit report (merged tri-bureau, <90 days old)',
            'Final signed closing disclosure',
            'Asset documentation (2 most recent statements)'
          ],
          correct: 2,
          explanation: 'The closing disclosure is generated later in the process, after AUS approval and during the closing preparation phase. All other documents (1003, credit report, and asset statements) are prerequisites for AUS submission as outlined in SOP-MF-002.'
        },
        {
          id: 3,
          type: 'scenario',
          difficulty: 'advanced',
          question: 'A borrower\'s initial DU submission returned "Approve/Eligible" findings. After updating the property value due to a new appraisal, the resubmission now returns "Refer" findings. What is the FIRST action you should take?',
          options: [
            'Proceed with manual underwriting immediately',
            'Stop the process, compare findings side-by-side, and escalate to Senior Underwriter',
            'Request a new appraisal from a different appraiser',
            'Inform the borrower that the loan is denied'
          ],
          correct: 1,
          explanation: 'Per SOP-MF-002 Step 6 (Resubmission Protocol), when findings worsen on resubmission, you must STOP, compare the findings side-by-side to identify the specific change causing the downgrade, and escalate to Senior Underwriter immediately. Never proceed or deny without proper escalation and analysis.'
        },
        {
          id: 4,
          type: 'true-false',
          difficulty: 'intermediate',
          question: 'True or False: A DU finding of "Approve/Eligible" automatically qualifies the loan for QM Safe Harbor status.',
          options: ['True', 'False'],
          correct: 0,
          explanation: 'True. Per the Compliance Requirements section of SOP-MF-002, a DU Approve/Eligible finding provides QM (Qualified Mortgage) Safe Harbor status under the Ability to Repay (ATR) rule. However, Approve/Ineligible complies with ATR but does not provide QM status.'
        },
        {
          id: 5,
          type: 'multiple-choice',
          difficulty: 'intermediate',
          question: 'What is the target turnaround time for submitting a complete file to AUS according to SOP-MF-002?',
          options: [
            '12 hours',
            '24 hours',
            '48 hours',
            '72 hours'
          ],
          correct: 1,
          explanation: 'SOP-MF-002 specifies a target turnaround of 24 hours from complete file receipt to AUS submission. This ensures timely processing and meets service level commitments to borrowers and loan officers.'
        },
        {
          id: 6,
          type: 'scenario',
          difficulty: 'advanced',
          question: 'You receive a "Data Validation Error" when submitting to DU after 3 attempts. The error message indicates an invalid property address. What should you do next?',
          options: [
            'Continue attempting to submit with the same address',
            'Change the property address to a nearby valid address',
            'Verify ZIP+4 code and ensure address matches Fannie Mae database format, then contact DU Support if error persists',
            'Abandon DU and submit to LPA instead'
          ],
          correct: 2,
          explanation: 'Per the Troubleshooting section of SOP-MF-002, if you encounter a Data Validation Error after correcting obvious issues, verify the property address format (especially ZIP+4). If the error persists after 3 attempts, contact Fannie Mae DU Support at 1-800-232-6643 rather than abandoning the process.'
        },
        {
          id: 7,
          type: 'multiple-choice',
          difficulty: 'beginner',
          question: 'When should you resubmit a loan to AUS?',
          options: [
            'Every week regardless of changes',
            'Only when changed circumstances occur (income, assets, credit, property value, loan parameters)',
            'Never - original findings are always final',
            'Only if the borrower requests it'
          ],
          correct: 1,
          explanation: 'Per Step 6 (AUS Resubmission Protocol), you should resubmit when changed circumstances occur: income/asset/credit changes, property value updates, loan parameter changes (LTV, rate, term, amount), after rate lock, or to correct errors in the original submission.'
        },
        {
          id: 8,
          type: 'true-false',
          difficulty: 'intermediate',
          question: 'True or False: If DU offers an appraisal waiver but the borrower wants a full appraisal, you must order the full appraisal.',
          options: ['True', 'False'],
          correct: 0,
          explanation: 'True. An appraisal waiver is an option, not a requirement. If the borrower prefers to obtain a full appraisal for peace of mind or other reasons, they can proceed with ordering one per SOP-MF-009. The waiver simply means it\'s not required by the AUS findings.'
        },
        {
          id: 9,
          type: 'scenario',
          difficulty: 'advanced',
          question: 'An LPA submission returns "Unable to Determine" findings. You\'ve verified all data fields are complete and accurate. What is the most appropriate next step?',
          options: [
            'Submit to Desktop Underwriter instead',
            'Deny the loan application',
            'Review the Feedback Certificate Messages section for specific issues, then route to manual underwriting if still unable to determine',
            'Resubmit with estimated data to get a finding'
          ],
          correct: 2,
          explanation: 'Per Troubleshooting for "LPA Unable to Determine," after providing missing data and verifying accuracy, if LPA still cannot determine eligibility with complete information, the loan should be routed to manual underwriting. Never use estimated data or deny without proper review.'
        },
        {
          id: 10,
          type: 'multiple-choice',
          difficulty: 'intermediate',
          question: 'According to SOP-MF-002, how long should DU/LPA findings be retained in the loan file?',
          options: [
            '1 year after closing',
            '3 years after closing',
            'Life of loan',
            'Life of loan + 3 years'
          ],
          correct: 3,
          explanation: 'Per the Record Retention section, all DU findings and LPA Feedback Certificates (all versions) must be maintained for the life of the loan plus 3 years, in accordance with investor requirements and regulatory compliance standards.'
        }
      ]
    };

    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));

      // Show selected tab
      document.getElementById(`tab-${tabName}`).classList.add('active');
      event.target.classList.add('active');
    }

    function generateQuiz() {
      const sopId = document.getElementById('sopSelect').value;
      const difficulty = document.getElementById('difficultySelect').value;
      const count = parseInt(document.getElementById('questionCount').value);

      if (!sopId) {
        alert('Please select an SOP first');
        return;
      }

      // Get questions for selected SOP
      let questions = mockQuestions[sopId] || [];

      // Filter by difficulty if not mixed
      if (difficulty !== 'mixed') {
        questions = questions.filter(q => q.difficulty === difficulty);
      }

      // Shuffle and limit to requested count
      questions = questions.sort(() => Math.random() - 0.5).slice(0, count);

      currentQuiz = {
        sopId,
        difficulty,
        questions,
        startTime: new Date()
      };

      currentQuestionIndex = 0;
      userAnswers = [];

      renderQuiz();
    }

    function renderQuiz() {
      const preview = document.getElementById('quizPreview');

      if (!currentQuiz || currentQuiz.questions.length === 0) {
        preview.innerHTML = `
          <div class="quiz-preview">
            <div style="text-align: center; padding: 40px; color: #a0aec0;">
              <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>
              <div style="font-size: 16px; color: #718096;">No questions available for this configuration</div>
            </div>
          </div>
        `;
        return;
      }

      const question = currentQuiz.questions[currentQuestionIndex];

      preview.innerHTML = `
        <div class="quiz-preview">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h3 style="font-size: 20px; color: #2d3748;">Quiz in Progress</h3>
            <div style="font-size: 14px; color: #718096;">
              Question ${currentQuestionIndex + 1} of ${currentQuiz.questions.length}
            </div>
          </div>

          <div class="question-card">
            <div class="question-header">
              <span class="question-number">Q${currentQuestionIndex + 1}</span>
              <span class="question-difficulty difficulty-${question.difficulty}">
                ${question.difficulty.charAt(0).toUpperCase() + question.difficulty.slice(1)}
              </span>
            </div>

            <div class="question-text">${question.question}</div>

            <div class="answer-options" id="answerOptions">
              ${question.options.map((option, index) => `
                <div class="answer-option" onclick="selectAnswer(${index})">
                  <input type="radio" name="answer" id="answer${index}" value="${index}">
                  <label for="answer${index}">${option}</label>
                </div>
              `).join('')}
            </div>

            <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: space-between;">
              <button class="btn btn-secondary" onclick="previousQuestion()"
                      ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                ‚Üê Previous
              </button>
              <button class="btn btn-primary" onclick="nextQuestion()" id="nextBtn">
                ${currentQuestionIndex === currentQuiz.questions.length - 1 ? 'Finish Quiz' : 'Next ‚Üí'}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function selectAnswer(index) {
      // Mark as selected
      document.querySelectorAll('.answer-option').forEach(opt => opt.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
      document.getElementById(`answer${index}`).checked = true;
    }

    function nextQuestion() {
      // Get selected answer
      const selected = document.querySelector('input[name="answer"]:checked');

      if (!selected) {
        alert('Please select an answer before continuing');
        return;
      }

      const answerIndex = parseInt(selected.value);
      userAnswers[currentQuestionIndex] = answerIndex;

      // Check if last question
      if (currentQuestionIndex === currentQuiz.questions.length - 1) {
        showResults();
      } else {
        currentQuestionIndex++;
        renderQuiz();
      }
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuiz();

        // Re-select previous answer if exists
        if (userAnswers[currentQuestionIndex] !== undefined) {
          setTimeout(() => {
            const prevAnswer = userAnswers[currentQuestionIndex];
            document.getElementById(`answer${prevAnswer}`).checked = true;
            document.querySelectorAll('.answer-option')[prevAnswer].classList.add('selected');
          }, 50);
        }
      }
    }

    function showResults() {
      const preview = document.getElementById('quizPreview');

      // Calculate score
      let correctCount = 0;
      currentQuiz.questions.forEach((q, i) => {
        if (userAnswers[i] === q.correct) {
          correctCount++;
        }
      });

      const percentage = Math.round((correctCount / currentQuiz.questions.length) * 100);
      const passed = percentage >= 70;

      let message = '';
      if (percentage >= 90) {
        message = 'üåü Excellent! You have mastered this SOP.';
      } else if (percentage >= 80) {
        message = '‚ú® Great job! You have a strong understanding.';
      } else if (percentage >= 70) {
        message = 'üëç Good work! You passed the quiz.';
      } else {
        message = 'üìö Keep studying. Review the SOP and try again.';
      }

      preview.innerHTML = `
        <div class="quiz-preview">
          <div class="quiz-results">
            <div class="results-score">${percentage}%</div>
            <div class="results-label">${correctCount} out of ${currentQuiz.questions.length} correct</div>
            <div class="results-message">${message}</div>
            <div class="results-actions">
              <button class="btn btn-success" onclick="reviewAnswers()">üìñ Review Answers</button>
              <button class="btn btn-secondary" onclick="retakeQuiz()">üîÑ Retake Quiz</button>
              <button class="btn btn-secondary" onclick="generateQuiz()">‚ú® New Quiz</button>
            </div>
          </div>
        </div>
      `;
    }

    function reviewAnswers() {
      const preview = document.getElementById('quizPreview');

      let html = `
        <div class="quiz-preview">
          <h3 style="font-size: 20px; color: #2d3748; margin-bottom: 24px;">üìñ Answer Review</h3>
      `;

      currentQuiz.questions.forEach((q, i) => {
        const userAnswer = userAnswers[i];
        const correct = userAnswer === q.correct;

        html += `
          <div class="question-card">
            <div class="question-header">
              <span class="question-number">Q${i + 1}</span>
              <span class="question-difficulty difficulty-${q.difficulty}">
                ${q.difficulty.charAt(0).toUpperCase() + q.difficulty.slice(1)}
              </span>
            </div>

            <div class="question-text">${q.question}</div>

            <div class="answer-options">
              ${q.options.map((option, index) => {
                let classes = 'answer-option';
                if (index === q.correct) classes += ' correct';
                else if (index === userAnswer && !correct) classes += ' incorrect';

                return `
                  <div class="${classes}">
                    <input type="radio" disabled ${index === userAnswer ? 'checked' : ''}>
                    <label>${option} ${index === q.correct ? '‚úì' : ''}</label>
                  </div>
                `;
              }).join('')}
            </div>

            <div class="explanation">
              <div class="explanation-title">${correct ? '‚úì Correct' : '‚úó Incorrect'}</div>
              <div class="explanation-text">${q.explanation}</div>
            </div>
          </div>
        `;
      });

      html += `
          <div style="margin-top: 24px;">
            <button class="btn btn-primary" onclick="generateQuiz()">‚ú® Start New Quiz</button>
          </div>
        </div>
      `;

      preview.innerHTML = html;
    }

    function retakeQuiz() {
      currentQuestionIndex = 0;
      userAnswers = [];
      currentQuiz.startTime = new Date();
      renderQuiz();
    }

    function previewSOP() {
      const sopId = document.getElementById('sopSelect').value;
      if (!sopId) {
        alert('Please select an SOP first');
        return;
      }
      window.location.href = `sop-viewer.html?sop=${sopId}`;
    }

    function downloadCert(certType) {
      alert(`üìÑ Downloading ${certType} certification PDF...\n\n(Feature coming soon)`);
    }

    function renewCert(certType) {
      alert(`Starting renewal process for ${certType} certification...\n\nYou'll be redirected to the quiz generator.`);
      switchTab('generator');
    }
  </script>
</body>
</html>
