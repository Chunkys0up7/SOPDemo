<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Processing - SOP Viewer</title>
  <style>
    :root {
      --primary-color: #0052CC;
      --primary-dark: #003d99;
      --text-dark: #2d3748;
      --text-light: #718096;
      --border-color: #e2e8f0;
      --bg-light: #f7fafc;
      --success-color: #48bb78;
      --warning-color: #ed8936;
      --danger-color: #f56565;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg-light);
    }

    .page-container {
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Breadcrumb */
    .breadcrumb {
      background: white;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border-color);
      font-size: 13px;
      color: var(--text-light);
    }

    .breadcrumb a {
      color: var(--primary-color);
      text-decoration: none;
    }

    .breadcrumb a:hover {
      text-decoration: underline;
    }

    /* Action Bar */
    .action-bar {
      background: white;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 61px;
      z-index: 100;
    }

    .action-left {
      display: flex;
      gap: 10px;
    }

    .action-right {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-secondary {
      background: var(--bg-light);
      color: var(--text-dark);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: #edf2f7;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    /* Main Layout */
    .main-layout {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      gap: 0;
      min-height: calc(100vh - 180px);
    }

    /* TOC Sidebar */
    .toc-sidebar {
      background: white;
      border-right: 1px solid var(--border-color);
      padding: 24px;
      position: sticky;
      top: 125px;
      height: calc(100vh - 125px);
      overflow-y: auto;
    }

    .toc-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .toc-list {
      list-style: none;
    }

    .toc-item {
      margin-bottom: 8px;
    }

    .toc-link {
      display: block;
      padding: 8px 12px;
      text-decoration: none;
      color: var(--text-dark);
      font-size: 14px;
      border-radius: 6px;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .toc-link:hover {
      background: var(--bg-light);
      border-left-color: var(--primary-color);
      transform: translateX(3px);
    }

    .toc-link.active {
      background: var(--bg-light);
      color: var(--primary-color);
      font-weight: 600;
      border-left-color: var(--primary-color);
    }

    .toc-subsection {
      list-style: none;
      margin-left: 16px;
      margin-top: 4px;
    }

    .toc-subsection .toc-link {
      font-size: 13px;
      color: var(--text-light);
    }

    .quick-actions {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border-color);
    }

    .quick-actions button {
      width: 100%;
      margin-bottom: 8px;
      justify-content: flex-start;
    }

    /* Main Content */
    .sop-content {
      background: white;
      padding: 40px;
      max-width: 900px;
    }

    .sop-header {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 2px solid var(--border-color);
    }

    .sop-title {
      font-size: 36px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 16px;
    }

    .sop-meta-row {
      display: flex;
      gap: 24px;
      font-size: 14px;
      color: var(--text-light);
    }

    .sop-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sop-meta-label {
      font-weight: 600;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-active {
      background: #c6f6d5;
      color: #22543d;
    }

    .section {
      margin-bottom: 40px;
      scroll-margin-top: 140px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 16px;
      padding: 12px;
      margin: -12px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .section-header:hover {
      background: var(--bg-light);
    }

    .section-header:hover .edit-section-btn {
      opacity: 1;
    }

    .section-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 16px;
    }

    .edit-section-btn {
      opacity: 0;
      transition: opacity 0.2s;
      padding: 6px 12px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .edit-section-btn:hover {
      background: var(--primary-dark);
    }

    .section-content {
      line-height: 1.7;
      color: var(--text-dark);
    }

    .section-content p {
      margin-bottom: 16px;
    }

    .section-content ul, .section-content ol {
      margin-bottom: 16px;
      padding-left: 24px;
    }

    .section-content li {
      margin-bottom: 8px;
    }

    .section-content h3 {
      font-size: 18px;
      font-weight: 600;
      margin-top: 24px;
      margin-bottom: 12px;
    }

    .section-content code {
      background: var(--bg-light);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
    }

    .section-content blockquote {
      border-left: 4px solid var(--primary-color);
      padding-left: 16px;
      margin: 16px 0;
      color: var(--text-light);
      font-style: italic;
    }

    /* Metadata Sidebar */
    .metadata-sidebar {
      background: white;
      border-left: 1px solid var(--border-color);
      padding: 24px;
      position: sticky;
      top: 125px;
      height: calc(100vh - 125px);
      overflow-y: auto;
    }

    .metadata-card {
      background: var(--bg-light);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .metadata-card h3 {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metadata-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid white;
      font-size: 13px;
    }

    .metadata-item:last-child {
      border-bottom: none;
    }

    .metadata-label {
      color: var(--text-light);
      font-weight: 600;
    }

    .metadata-value {
      color: var(--text-dark);
      font-weight: 500;
    }

    .dependency-list {
      list-style: none;
    }

    .dependency-item {
      padding: 10px;
      background: white;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 13px;
      border-left: 3px solid var(--primary-color);
    }

    .dependency-item a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 600;
    }

    .dependency-item a:hover {
      text-decoration: underline;
    }

    .dependency-type {
      font-size: 11px;
      color: var(--text-light);
      display: block;
      margin-top: 4px;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 16px;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .main-layout {
        grid-template-columns: 250px 1fr;
      }

      .metadata-sidebar {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .main-layout {
        grid-template-columns: 1fr;
      }

      .toc-sidebar {
        display: none;
      }

      .sop-content {
        padding: 20px;
      }
    }

    /* Edit Mode Styles */
    .edit-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .edit-modal.active {
      display: flex;
    }

    .edit-container {
      background: white;
      border-radius: 12px;
      width: 95%;
      max-width: 1400px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .edit-header {
      padding: 20px 24px;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-light);
      border-radius: 12px 12px 0 0;
    }

    .edit-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .edit-subtitle {
      font-size: 13px;
      color: var(--text-light);
      margin-top: 4px;
    }

    .edit-actions {
      display: flex;
      gap: 10px;
    }

    .edit-body {
      display: grid;
      grid-template-columns: 1fr 1fr 350px;
      gap: 0;
      flex: 1;
      overflow: hidden;
    }

    .editor-panel, .preview-panel, .impact-panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .editor-panel {
      border-right: 1px solid var(--border-color);
    }

    .preview-panel {
      border-right: 1px solid var(--border-color);
      background: #fafafa;
    }

    .impact-panel {
      background: #fffaf0;
    }

    .panel-header {
      padding: 12px 16px;
      background: white;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      font-size: 14px;
      color: var(--text-dark);
    }

    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    /* Markdown Toolbar */
    .markdown-toolbar {
      display: flex;
      gap: 4px;
      padding: 8px 12px;
      background: var(--bg-light);
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
    }

    .toolbar-btn {
      background: white;
      border: 1px solid var(--border-color);
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-dark);
      transition: all 0.2s;
    }

    .toolbar-btn:hover {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .toolbar-separator {
      width: 1px;
      background: var(--border-color);
      margin: 0 4px;
    }

    /* Editor Textarea */
    .markdown-editor {
      width: 100%;
      height: 100%;
      border: none;
      padding: 16px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      line-height: 1.6;
      resize: none;
      outline: none;
      background: white;
    }

    /* Preview Content */
    .preview-content {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
    }

    .preview-content h1 {
      font-size: 24px;
      margin-bottom: 12px;
      color: var(--text-dark);
    }

    .preview-content h2 {
      font-size: 20px;
      margin-top: 24px;
      margin-bottom: 10px;
      color: var(--text-dark);
    }

    .preview-content h3 {
      font-size: 16px;
      margin-top: 20px;
      margin-bottom: 8px;
      color: var(--text-dark);
    }

    .preview-content p {
      margin-bottom: 12px;
      color: var(--text-dark);
    }

    .preview-content ul, .preview-content ol {
      margin-bottom: 12px;
      padding-left: 24px;
    }

    .preview-content li {
      margin-bottom: 6px;
    }

    .preview-content code {
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
    }

    .preview-content a {
      color: var(--primary-color);
      text-decoration: none;
    }

    .preview-content a:hover {
      text-decoration: underline;
    }

    /* Impact Analysis */
    .impact-warning {
      background: #fff5f5;
      border-left: 4px solid var(--danger-color);
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 4px;
    }

    .impact-info {
      background: #f0f9ff;
      border-left: 4px solid var(--primary-color);
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 4px;
    }

    .impact-title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 8px;
      color: var(--text-dark);
    }

    .impact-list {
      font-size: 13px;
      line-height: 1.6;
    }

    .impact-item {
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .impact-item:last-child {
      border-bottom: none;
    }

    .impact-sop {
      font-weight: 600;
      color: var(--text-dark);
      display: block;
      margin-bottom: 4px;
    }

    .impact-section {
      font-size: 12px;
      color: var(--text-light);
      margin-left: 12px;
    }

    .risk-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .risk-high {
      background: #fed7d7;
      color: #742a2a;
    }

    .risk-medium {
      background: #feebc8;
      color: #7c2d12;
    }

    .risk-low {
      background: #c6f6d5;
      color: #22543d;
    }

    /* Auto-save indicator */
    .autosave-indicator {
      font-size: 12px;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .autosave-indicator.saving {
      color: var(--warning-color);
    }

    .autosave-indicator.saved {
      color: var(--success-color);
    }

    /* Version History Modal */
    .version-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .version-modal.active {
      display: flex;
    }

    .version-container {
      background: white;
      border-radius: 12px;
      width: 95%;
      max-width: 1200px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .version-header {
      padding: 20px 24px;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-light);
      border-radius: 12px 12px 0 0;
    }

    .version-body {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 0;
      flex: 1;
      overflow: hidden;
    }

    .version-list-panel {
      border-right: 1px solid var(--border-color);
      overflow-y: auto;
      background: white;
    }

    .version-item {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.2s;
    }

    .version-item:hover {
      background: var(--bg-light);
    }

    .version-item.active {
      background: #eef2ff;
      border-left: 4px solid var(--primary-color);
    }

    .version-number {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-dark);
      margin-bottom: 4px;
    }

    .version-date {
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .version-author {
      font-size: 13px;
      color: var(--text-dark);
    }

    .version-changes {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 4px;
    }

    .current-badge {
      display: inline-block;
      padding: 2px 8px;
      background: var(--success-color);
      color: white;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .version-diff-panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .diff-toolbar {
      padding: 16px 20px;
      background: white;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .diff-mode-toggle {
      display: flex;
      gap: 8px;
    }

    .diff-mode-btn {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .diff-mode-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .diff-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #fafafa;
    }

    .diff-view {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .diff-view.side-by-side {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }

    .diff-view.unified {
      display: block;
    }

    .diff-column {
      border-right: 1px solid var(--border-color);
    }

    .diff-column:last-child {
      border-right: none;
    }

    .diff-column-header {
      padding: 12px 16px;
      background: var(--bg-light);
      border-bottom: 2px solid var(--border-color);
      font-weight: 600;
      font-size: 14px;
      color: var(--text-dark);
    }

    .diff-line {
      padding: 4px 16px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      line-height: 1.6;
      border-bottom: 1px solid #f0f0f0;
    }

    .diff-line-number {
      display: inline-block;
      width: 40px;
      color: var(--text-light);
      user-select: none;
      margin-right: 16px;
    }

    .diff-line.added {
      background: #e6ffec;
      border-left: 3px solid var(--success-color);
    }

    .diff-line.removed {
      background: #ffebe9;
      border-left: 3px solid var(--danger-color);
    }

    .diff-line.unchanged {
      background: white;
    }

    .diff-section-header {
      padding: 12px 16px;
      background: #f8f9fa;
      border-left: 4px solid var(--primary-color);
      font-weight: 600;
      color: var(--text-dark);
      margin-top: 8px;
    }

    .version-metadata {
      background: #fffaf0;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      border-left: 4px solid var(--warning-color);
    }

    .metadata-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .metadata-label {
      font-weight: 600;
      color: var(--text-dark);
    }

    .metadata-value {
      color: var(--text-light);
    }

    .restore-btn {
      padding: 8px 16px;
      background: var(--warning-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .restore-btn:hover {
      background: #dd6b20;
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <!-- Include global navigation -->
  <div id="global-nav-container"></div>

  <div class="page-container">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <a href="/">Home</a> /
      <a href="/public/browse.html?dept=finance">Finance</a> /
      <span>Invoice Processing</span>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <div class="action-left">
        <button class="btn btn-secondary" onclick="window.history.back()">
          <span>‚Üê</span>
          <span>Back</span>
        </button>
        <button class="btn btn-secondary">
          <span>‚≠ê</span>
          <span>Bookmark</span>
        </button>
        <button class="btn btn-secondary">
          <span>üëÅÔ∏è</span>
          <span>Watch</span>
        </button>
      </div>

      <div class="action-right">
        <button class="btn btn-primary" onclick="enterEditMode()">
          <span>‚úèÔ∏è</span>
          <span>Edit SOP</span>
        </button>
        <button class="btn btn-secondary" onclick="showMoreActions()">
          <span>‚ãÆ</span>
        </button>
      </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
      <!-- TOC Sidebar -->
      <aside class="toc-sidebar">
        <h3 class="toc-title">Table of Contents</h3>
        <ul class="toc-list">
          <li class="toc-item">
            <a href="#overview" class="toc-link active">Overview</a>
          </li>
          <li class="toc-item">
            <a href="#prerequisites" class="toc-link">Prerequisites</a>
          </li>
          <li class="toc-item">
            <a href="#procedure" class="toc-link">Procedure Steps</a>
            <ul class="toc-subsection">
              <li class="toc-item"><a href="#step-1" class="toc-link">Step 1: Receive Invoice</a></li>
              <li class="toc-item"><a href="#step-2" class="toc-link">Step 2: Verify Details</a></li>
              <li class="toc-item"><a href="#step-3" class="toc-link">Step 3: Get Approval</a></li>
              <li class="toc-item"><a href="#step-4" class="toc-link">Step 4: Process Payment</a></li>
            </ul>
          </li>
          <li class="toc-item">
            <a href="#quality-checks" class="toc-link">Quality Checks</a>
          </li>
          <li class="toc-item">
            <a href="#troubleshooting" class="toc-link">Troubleshooting</a>
          </li>
          <li class="toc-item">
            <a href="#references" class="toc-link">References</a>
          </li>
        </ul>

        <div class="quick-actions">
          <button class="btn btn-secondary" onclick="showDependencies()">
            <span>üîó</span>
            <span>View Dependencies</span>
          </button>
          <button class="btn btn-secondary" onclick="showVersionHistory()">
            <span>üìú</span>
            <span>Version History</span>
          </button>
          <button class="btn btn-secondary" onclick="showComments()">
            <span>üí¨</span>
            <span>Comments (5)</span>
          </button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="sop-content">
        <!-- SOP Header -->
        <div class="sop-header">
          <h1 class="sop-title">Invoice Processing Procedure</h1>
          <div class="sop-meta-row">
            <div class="sop-meta-item">
              <span class="sop-meta-label">ID:</span>
              <span>SOP-001</span>
            </div>
            <div class="sop-meta-item">
              <span class="sop-meta-label">Version:</span>
              <span>1.2.0</span>
            </div>
            <div class="sop-meta-item">
              <span class="sop-meta-label">Owner:</span>
              <span>Finance Department</span>
            </div>
            <div class="sop-meta-item">
              <span class="sop-meta-label">Status:</span>
              <span class="status-badge status-active">Active</span>
            </div>
            <div class="sop-meta-item">
              <span class="sop-meta-label">Last Updated:</span>
              <span>2025-11-01</span>
            </div>
          </div>
        </div>

        <!-- Section: Overview -->
        <section class="section" id="overview">
          <div class="section-header">
            <h2 class="section-title">Overview</h2>
            <button class="edit-section-btn" onclick="editSection('overview')">
              ‚úèÔ∏è Edit Section
            </button>
          </div>
          <div class="section-content">
            <p>This Standard Operating Procedure (SOP) defines the process for receiving, verifying, approving, and processing invoices for payment. This procedure ensures timely and accurate payment to vendors while maintaining proper financial controls and compliance with company policies.</p>

            <p><strong>Purpose:</strong> To establish a standardized process for invoice handling that minimizes errors, prevents fraud, and ensures compliance with accounting standards and SOX requirements.</p>

            <p><strong>Scope:</strong> This procedure applies to all invoices received by the Finance Department from external vendors for goods and services.</p>
          </div>
        </section>

        <!-- Section: Prerequisites -->
        <section class="section" id="prerequisites">
          <div class="section-header">
            <h2 class="section-title">Prerequisites</h2>
            <button class="edit-section-btn" onclick="editSection('prerequisites')">
              ‚úèÔ∏è Edit Section
            </button>
          </div>
          <div class="section-content">
            <p>Before processing invoices, ensure the following requirements are met:</p>

            <ul>
              <li><strong>System Access:</strong> Workday Finance Module and SAP vendor database access. See <a href="/public/sop-viewer.html?id=sop-002">SOP-002: IT System Access</a> for access provisioning.</li>
              <li><strong>Training:</strong> Completion of Finance Fundamentals and SOX Compliance training. See <a href="/public/sop-viewer.html?id=sop-003">SOP-003: Security Training</a>.</li>
              <li><strong>Approver Authority:</strong> Ensure you have the appropriate approval authority level for invoice amounts you'll be processing.</li>
              <li><strong>Vendor Setup:</strong> Vendor must be registered in the system with current W-9 and banking information.</li>
            </ul>

            <blockquote>
              <strong>Note:</strong> Invoices from unregistered vendors must be routed to the Vendor Setup team before processing. Allow 2-3 business days for vendor registration.
            </blockquote>
          </div>
        </section>

        <!-- Section: Procedure Steps -->
        <section class="section" id="procedure">
          <div class="section-header">
            <h2 class="section-title">Procedure Steps</h2>
            <button class="edit-section-btn" onclick="editSection('procedure')">
              ‚úèÔ∏è Edit Section
            </button>
          </div>
          <div class="section-content">
            <h3 id="step-1">Step 1: Receive Invoice</h3>
            <ol>
              <li>Invoices are received via:
                <ul>
                  <li>Email: <code>ap@company.com</code></li>
                  <li>Mail: Finance Department, Building A</li>
                  <li>Vendor Portal: Submit directly to Workday</li>
                </ul>
              </li>
              <li>Log invoice into Workday within 24 hours of receipt</li>
              <li>Scan paper invoices and attach to Workday record</li>
              <li>Verify invoice includes:
                <ul>
                  <li>Vendor name and address</li>
                  <li>Invoice number and date</li>
                  <li>Purchase order number (if applicable)</li>
                  <li>Itemized list of goods/services</li>
                  <li>Total amount due</li>
                  <li>Payment terms</li>
                </ul>
              </li>
            </ol>

            <h3 id="step-2">Step 2: Verify Invoice Details</h3>
            <ol>
              <li>Match invoice to purchase order (PO) in SAP
                <ul>
                  <li>Verify quantities match PO</li>
                  <li>Verify unit prices match PO</li>
                  <li>Check for any unauthorized additions</li>
                </ul>
              </li>
              <li>For non-PO invoices (under $5,000):
                <ul>
                  <li>Verify budget approval in email/documentation</li>
                  <li>Confirm department manager pre-authorization</li>
                </ul>
              </li>
              <li>Check for calculation errors and correct totals</li>
              <li>Verify tax calculations are correct for jurisdiction</li>
            </ol>

            <h3 id="step-3">Step 3: Obtain Approval</h3>
            <ol>
              <li>Route invoice for approval based on amount:
                <ul>
                  <li><strong>$0 - $5,000:</strong> Department Manager</li>
                  <li><strong>$5,001 - $25,000:</strong> Department Manager + Finance Manager</li>
                  <li><strong>$25,001 - $100,000:</strong> Department Manager + Finance Manager + Controller</li>
                  <li><strong>Over $100,000:</strong> Department Manager + Finance Manager + Controller + CFO</li>
                </ul>
              </li>
              <li>Send approval request via Workday workflow</li>
              <li>SLA for approval: 3 business days per approver</li>
              <li>If rejected, work with vendor to resolve discrepancies</li>
            </ol>

            <h3 id="step-4">Step 4: Process Payment</h3>
            <ol>
              <li>Once fully approved, schedule payment based on terms:
                <ul>
                  <li>Net 30: Schedule for day 28-30</li>
                  <li>Net 45: Schedule for day 43-45</li>
                  <li>Early payment discount: Schedule to capture discount</li>
                </ul>
              </li>
              <li>Execute payment batch in Workday</li>
              <li>Send payment confirmation to vendor via email</li>
              <li>Update SAP records and close invoice</li>
              <li>Archive invoice documents per retention policy (7 years)</li>
            </ol>
          </div>
        </section>

        <!-- Section: Quality Checks -->
        <section class="section" id="quality-checks">
          <div class="section-header">
            <h2 class="section-title">Quality Checks</h2>
            <button class="edit-section-btn" onclick="editSection('quality-checks')">
              ‚úèÔ∏è Edit Section
            </button>
          </div>
          <div class="section-content">
            <p>Perform the following quality checks before final processing:</p>

            <ul>
              <li>‚úì Invoice number is not a duplicate in the system</li>
              <li>‚úì Vendor is active and in good standing</li>
              <li>‚úì All required approvals are obtained</li>
              <li>‚úì Payment terms are correctly entered</li>
              <li>‚úì GL coding is accurate and approved</li>
              <li>‚úì Supporting documentation is attached</li>
              <li>‚úì Tax treatment is appropriate</li>
              <li>‚úì Payment method matches vendor preference</li>
            </ul>
          </div>
        </section>

        <!-- Section: Troubleshooting -->
        <section class="section" id="troubleshooting">
          <div class="section-header">
            <h2 class="section-title">Troubleshooting</h2>
            <button class="edit-section-btn" onclick="editSection('troubleshooting')">
              ‚úèÔ∏è Edit Section
            </button>
          </div>
          <div class="section-content">
            <p><strong>Common Issues and Solutions:</strong></p>

            <p><strong>Invoice doesn't match PO:</strong></p>
            <ul>
              <li>Contact vendor for corrected invoice</li>
              <li>If price increase, require new PO approval</li>
              <li>Document all communications in Workday</li>
            </ul>

            <p><strong>Duplicate invoice detected:</strong></p>
            <ul>
              <li>Contact vendor to verify</li>
              <li>Check if previous payment was processed</li>
              <li>Mark duplicate and do not process</li>
            </ul>

            <p><strong>Missing approver:</strong></p>
            <ul>
              <li>Check org chart for current approver</li>
              <li>If approver out of office, route to backup per delegation matrix</li>
              <li>Escalate to Finance Manager if unresolved after 5 days</li>
            </ul>
          </div>
        </section>

        <!-- Section: References -->
        <section class="section" id="references">
          <div class="section-header">
            <h2 class="section-title">References</h2>
            <button class="edit-section-btn" onclick="editSection('references')">
              ‚úèÔ∏è Edit Section
            </button>
          </div>
          <div class="section-content">
            <ul>
              <li><a href="/public/sop-viewer.html?id=sop-002">SOP-002: IT System Access Provisioning</a></li>
              <li><a href="/public/sop-viewer.html?id=sop-003">SOP-003: Security Training Completion</a></li>
              <li><a href="/public/sop-viewer.html?id=sop-004">SOP-004: Equipment Requisition</a> (for approval chain reference)</li>
              <li><a href="#">Finance Policy Manual - Section 4.2: Accounts Payable</a></li>
              <li><a href="#">SOX Compliance Guide - Invoice Controls</a></li>
            </ul>
          </div>
        </section>
      </main>

      <!-- Metadata Sidebar -->
      <aside class="metadata-sidebar">
        <div class="metadata-card">
          <h3>üìã Document Info</h3>
          <div class="metadata-item">
            <span class="metadata-label">Type:</span>
            <span class="metadata-value" id="doc-type">SOP</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Department:</span>
            <span class="metadata-value" id="doc-department">Finance</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Category:</span>
            <span class="metadata-value" id="doc-category">N/A</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Complexity:</span>
            <span class="metadata-value" id="doc-complexity">N/A</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Last Review:</span>
            <span class="metadata-value" id="doc-last-review">2025-10-15</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Next Review:</span>
            <span class="metadata-value" id="doc-next-review">2026-10-15</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Approver:</span>
            <span class="metadata-value" id="doc-approver">Jane Smith</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Maintainer:</span>
            <span class="metadata-value" id="doc-maintainer">N/A</span>
          </div>
        </div>

        <div class="metadata-card">
          <h3>üë• Audience</h3>
          <div id="audience-list" style="display: flex; flex-direction: column; gap: 8px;">
            <div style="font-size: 13px; color: #718096;">Loading...</div>
          </div>
        </div>

        <div class="metadata-card">
          <h3>‚öñÔ∏è Compliance</h3>
          <div id="compliance-list" style="display: flex; flex-wrap: wrap; gap: 6px;">
            <div style="font-size: 13px; color: #718096;">Loading...</div>
          </div>
        </div>

        <div class="metadata-card">
          <h3>‚ôªÔ∏è Reusability</h3>
          <div class="metadata-item">
            <span class="metadata-label">Used In:</span>
            <span class="metadata-value" id="used-in-count">0</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Variations:</span>
            <span class="metadata-value" id="variation-count">1</span>
          </div>
          <div id="used-in-list" style="margin-top: 12px; display: flex; flex-direction: column; gap: 4px;">
          </div>
        </div>

        <div class="metadata-card">
          <h3>üîó Dependencies</h3>
          <ul class="dependency-list">
            <li class="dependency-item">
              <a href="/public/sop-viewer.html?id=sop-002">SOP-002: IT System Access</a>
              <span class="dependency-type">Depends on (Strong)</span>
            </li>
            <li class="dependency-item">
              <a href="/public/sop-viewer.html?id=sop-003">SOP-003: Security Training</a>
              <span class="dependency-type">Depends on (Strong)</span>
            </li>
          </ul>
          <div class="action-buttons">
            <button class="btn btn-secondary" onclick="window.location.href='/public/sop-dependencies.html'">
              View Full Details ‚Üí
            </button>
          </div>
        </div>

        <div class="metadata-card">
          <h3>üìä Usage Stats</h3>
          <div class="metadata-item">
            <span class="metadata-label">Views:</span>
            <span class="metadata-value">1,247</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Bookmarks:</span>
            <span class="metadata-value">23</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Watchers:</span>
            <span class="metadata-value">8</span>
          </div>
        </div>

        <div class="metadata-card">
          <h3>‚ö° Quick Actions</h3>
          <div class="action-buttons">
            <button class="btn btn-secondary" onclick="downloadPDF()">
              üìÑ Download PDF
            </button>
            <button class="btn btn-secondary" onclick="shareSOP()">
              üì§ Share
            </button>
            <button class="btn btn-secondary" onclick="printSOP()">
              üñ®Ô∏è Print
            </button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Edit Mode Modal -->
  <div class="edit-modal" id="editModal">
    <div class="edit-container">
      <div class="edit-header">
        <div>
          <div class="edit-title" id="editTitle">Edit Section</div>
          <div class="edit-subtitle" id="editSubtitle">Invoice Processing - Section: Overview</div>
        </div>
        <div class="edit-actions">
          <div class="autosave-indicator" id="autosaveIndicator">
            <span>‚óè</span>
            <span id="autosaveText">All changes saved</span>
          </div>
          <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
          <button class="btn btn-primary" onclick="saveEdit()">üíæ Save Changes</button>
        </div>
      </div>

      <div class="edit-body">
        <!-- Editor Panel -->
        <div class="editor-panel">
          <div class="panel-header">‚úèÔ∏è Markdown Editor</div>
          <div class="markdown-toolbar">
            <button class="toolbar-btn" onclick="insertMarkdown('# ', '')" title="Heading 1">H1</button>
            <button class="toolbar-btn" onclick="insertMarkdown('## ', '')" title="Heading 2">H2</button>
            <button class="toolbar-btn" onclick="insertMarkdown('### ', '')" title="Heading 3">H3</button>
            <div class="toolbar-separator"></div>
            <button class="toolbar-btn" onclick="insertMarkdown('**', '**')" title="Bold"><strong>B</strong></button>
            <button class="toolbar-btn" onclick="insertMarkdown('_', '_')" title="Italic"><em>I</em></button>
            <button class="toolbar-btn" onclick="insertMarkdown('`', '`')" title="Code">Code</button>
            <div class="toolbar-separator"></div>
            <button class="toolbar-btn" onclick="insertMarkdown('- ', '')" title="Bullet List">‚Ä¢ List</button>
            <button class="toolbar-btn" onclick="insertMarkdown('1. ', '')" title="Numbered List">1. List</button>
            <div class="toolbar-separator"></div>
            <button class="toolbar-btn" onclick="insertMarkdown('[', '](url)')" title="Link">üîó Link</button>
            <button class="toolbar-btn" onclick="insertMarkdown('{{include: ', '}}')" title="Include Component">üì¶ Include</button>
          </div>
          <textarea class="markdown-editor" id="markdownEditor" placeholder="Write your content in markdown..."></textarea>
        </div>

        <!-- Preview Panel -->
        <div class="preview-panel">
          <div class="panel-header">üëÅÔ∏è Live Preview</div>
          <div class="panel-content">
            <div class="preview-content" id="previewContent">
              <p style="color: #a0aec0;">Preview will appear here as you type...</p>
            </div>
          </div>
        </div>

        <!-- Impact Analysis Panel -->
        <div class="impact-panel">
          <div class="panel-header">‚ö° Impact Analysis</div>
          <div class="panel-content" id="impactContent">
            <div class="impact-info">
              <div class="impact-title">‚úÖ Change Impact</div>
              <div class="impact-list">
                <p>Analyzing dependencies...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Version History Modal -->
  <div class="version-modal" id="versionModal">
    <div class="version-container">
      <div class="version-header">
        <div>
          <div class="edit-title">üìú Version History</div>
          <div class="edit-subtitle">Invoice Processing - Complete version timeline</div>
        </div>
        <div class="edit-actions">
          <button class="btn btn-secondary" onclick="closeVersionModal()">Close</button>
        </div>
      </div>

      <div class="version-body">
        <!-- Version List Sidebar -->
        <div class="version-list-panel" id="versionList">
          <!-- Versions will be rendered here -->
        </div>

        <!-- Diff Viewer Panel -->
        <div class="version-diff-panel">
          <div class="diff-toolbar">
            <div class="diff-mode-toggle">
              <button class="diff-mode-btn active" data-mode="side-by-side" onclick="changeDiffMode('side-by-side')">
                Side by Side
              </button>
              <button class="diff-mode-btn" data-mode="unified" onclick="changeDiffMode('unified')">
                Unified
              </button>
            </div>
            <button class="restore-btn" id="restoreBtn" onclick="restoreVersion()">
              ‚Ü∫ Restore This Version
            </button>
          </div>

          <div class="diff-content" id="diffContent">
            <div class="version-metadata">
              <div class="metadata-row">
                <span class="metadata-label">Version:</span>
                <span class="metadata-value" id="selectedVersion">Select a version</span>
              </div>
              <div class="metadata-row">
                <span class="metadata-label">Author:</span>
                <span class="metadata-value" id="versionAuthor">-</span>
              </div>
              <div class="metadata-row">
                <span class="metadata-label">Date:</span>
                <span class="metadata-value" id="versionDate">-</span>
              </div>
              <div class="metadata-row">
                <span class="metadata-label">Change Summary:</span>
                <span class="metadata-value" id="versionSummary">-</span>
              </div>
            </div>

            <div id="diffViewer">
              <p style="text-align: center; color: #a0aec0; padding: 40px;">
                Select a version from the list to view changes
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Load enhanced metadata from graph
    async function loadEnhancedMetadata() {
      try {
        // Get SOP ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const sopId = urlParams.get('sop') || urlParams.get('id') || 'sop-it-001';

        // Load graph data
        const response = await fetch('/graph/sop-graph.json');
        const graphData = await response.json();

        // Find the SOP in the graph
        const sopData = graphData.nodes[sopId];

        if (sopData) {
          // Update document info
          document.getElementById('doc-type').textContent = sopData.type?.toUpperCase() || 'SOP';
          document.getElementById('doc-department').textContent = sopData.department || sopData.owner || 'N/A';
          document.getElementById('doc-category').textContent = sopData.processCategory || 'N/A';
          document.getElementById('doc-complexity').textContent = sopData.complexity || 'N/A';
          document.getElementById('doc-last-review').textContent = sopData.lastReviewed || sopData.metadata?.lastReviewed || 'N/A';
          document.getElementById('doc-next-review').textContent = sopData.nextReview || 'N/A';
          document.getElementById('doc-approver').textContent = sopData.approver || sopData.metadata?.approver || 'N/A';
          document.getElementById('doc-maintainer').textContent = sopData.maintainer || 'N/A';

          // Update audience
          const audienceList = document.getElementById('audience-list');
          if (sopData.audience && sopData.audience.length > 0) {
            audienceList.innerHTML = sopData.audience.map(aud => `
              <div style="font-size: 13px; color: #4a5568; padding: 6px 12px; background: #f7fafc; border-radius: 6px;">
                üë§ ${aud}
              </div>
            `).join('');
          } else {
            audienceList.innerHTML = '<div style="font-size: 13px; color: #a0aec0;">No audience specified</div>';
          }

          // Update compliance frameworks
          const complianceList = document.getElementById('compliance-list');
          if (sopData.complianceFrameworks && sopData.complianceFrameworks.length > 0) {
            complianceList.innerHTML = sopData.complianceFrameworks.map(fw => `
              <span style="padding: 4px 10px; background: #fef3c7; color: #92400e; border-radius: 12px; font-size: 11px; font-weight: 600;">
                ${fw}
              </span>
            `).join('');
          } else {
            complianceList.innerHTML = '<div style="font-size: 13px; color: #a0aec0;">No compliance frameworks</div>';
          }

          // Update reusability info
          const reusableIn = sopData.reusableIn || [];
          document.getElementById('used-in-count').textContent = reusableIn.length;
          document.getElementById('variation-count').textContent = sopData.variationCount || 1;

          const usedInList = document.getElementById('used-in-list');
          if (reusableIn.length > 0) {
            usedInList.innerHTML = reusableIn.slice(0, 5).map(id => `
              <a href="/public/sop-viewer.html?id=${id}" style="font-size: 12px; color: #0052CC; text-decoration: none; padding: 4px 8px; background: #ebf4ff; border-radius: 6px; display: block;">
                ‚Üí ${id}
              </a>
            `).join('');
          } else {
            usedInList.innerHTML = '<div style="font-size: 12px; color: #a0aec0;">Not reused</div>';
          }

          console.log(`‚úÖ Loaded enhanced metadata for ${sopId}`);
        } else {
          console.warn(`SOP ${sopId} not found in graph`);
        }
      } catch (error) {
        console.error('Error loading enhanced metadata:', error);
      }
    }

    // Load global navigation
    fetch('/public/components/global-nav.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('global-nav-container').innerHTML = html;
      });

    // Load enhanced metadata when page loads
    window.addEventListener('DOMContentLoaded', () => {
      loadEnhancedMetadata();
    });

    // TOC scroll spy
    const sections = document.querySelectorAll('.section');
    const tocLinks = document.querySelectorAll('.toc-link');

    window.addEventListener('scroll', () => {
      let current = '';
      sections.forEach(section => {
        const sectionTop = section.offsetTop;
        const sectionHeight = section.clientHeight;
        if (window.pageYOffset >= sectionTop - 200) {
          current = section.getAttribute('id');
        }
      });

      tocLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === `#${current}`) {
          link.classList.add('active');
        }
      });
    });

    // Smooth scroll for TOC links
    tocLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href');
        const targetSection = document.querySelector(targetId);
        if (targetSection) {
          targetSection.scrollIntoView({ behavior: 'smooth' });
        }
      });
    });

    // Edit Mode State
    let currentEditSection = null;
    let originalContent = '';
    let autosaveTimer = null;
    let isDirty = false;

    // Mock section content database
    const sectionContent = {
      'overview': `## Overview

This SOP defines the end-to-end process for processing invoices in the accounting system, from receipt to payment authorization.

**Purpose:** Ensure all invoices are processed accurately, efficiently, and in compliance with financial controls.

**Scope:** Applies to all invoices for goods and services received by the organization.`,

      'prerequisites': `## Prerequisites

Before initiating invoice processing, ensure the following are in place:

- **Access Requirements:**
  - ERP system credentials (see {{include: sop-002}} for access provisioning)
  - Accounts Payable module permissions

- **Required Training:**
  - Finance onboarding ({{include: sop-003}})
  - Invoice processing certification

- **Tools & Systems:**
  - ERP system (SAP/Oracle)
  - Invoice scanning software
  - Approval workflow system`,

      'procedure-steps': `## Procedure Steps

### Step 1: Invoice Receipt & Validation
1. Receive invoice via email or physical mail
2. Verify invoice contains:
   - Valid PO number
   - Correct vendor information
   - Itemized charges
   - Proper tax calculations
3. Scan physical invoices into digital system

### Step 2: Three-Way Match
1. Match invoice to:
   - Purchase Order (PO)
   - Receiving report
   - Contract terms (if applicable)
2. Verify quantities and prices match
3. Flag discrepancies for resolution

### Step 3: Approval Routing
1. Route to department manager for approval
2. Route to Finance Controller if >$10,000
3. Route to CFO if >$50,000
4. Track approval status in workflow system

### Step 4: Payment Processing
1. Schedule payment according to terms
2. Process payment via ACH or check
3. Record transaction in general ledger
4. Send payment confirmation to vendor`,

      'quality-checks': `## Quality Checks

Perform the following checks before finalizing:

- [ ] All invoice fields populated correctly
- [ ] Three-way match completed successfully
- [ ] Approvals obtained from authorized personnel
- [ ] Tax calculations verified
- [ ] Duplicate invoice check performed
- [ ] Vendor payment details confirmed`,

      'troubleshooting': `## Troubleshooting

### Invoice Doesn't Match PO
- Verify PO number is correct
- Check for partial deliveries
- Contact purchasing department
- May require PO amendment

### Missing Approval
- Check approval workflow status
- Send reminder to approver
- Escalate to manager if >3 days overdue

### System Access Issues
- Verify credentials are current
- Check role permissions
- Contact IT helpdesk
- Reference {{include: sop-002}} for access requests`,

      'references': `## References

### Related SOPs
- [SOP-002: IT System Access Provisioning](/public/sop-viewer.html?id=sop-002)
- [SOP-003: Security Training Completion](/public/sop-viewer.html?id=sop-003)
- [SOP-004: Equipment Requisition](/public/sop-viewer.html?id=sop-004) (for approval chain reference)

### External Documentation
- [Finance Policy Manual - Section 4.2: Accounts Payable](#)
- [SOX Compliance Guide - Invoice Controls](#)`
    };

    // Edit section
    function editSection(sectionId) {
      currentEditSection = sectionId;

      // Get content for this section
      const content = sectionContent[sectionId] || `## ${sectionId}\n\nSection content would be loaded here...`;
      originalContent = content;

      // Update modal title
      document.getElementById('editTitle').textContent = 'Edit Section';
      document.getElementById('editSubtitle').textContent = `Invoice Processing - Section: ${formatSectionName(sectionId)}`;

      // Load content into editor
      document.getElementById('markdownEditor').value = content;

      // Generate initial preview
      updatePreview();

      // Run impact analysis
      analyzeImpact();

      // Show modal
      document.getElementById('editModal').classList.add('active');

      // Reset dirty flag
      isDirty = false;
      updateAutosaveIndicator('saved');

      // Focus editor
      setTimeout(() => {
        document.getElementById('markdownEditor').focus();
      }, 100);
    }

    // Enter edit mode (for full SOP editing)
    function enterEditMode() {
      editSection('overview'); // Start with first section
      document.getElementById('editTitle').textContent = 'Edit Entire SOP';
    }

    // Format section name for display
    function formatSectionName(sectionId) {
      return sectionId
        .split('-')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    // Update live preview
    function updatePreview() {
      const markdown = document.getElementById('markdownEditor').value;
      const preview = document.getElementById('previewContent');

      // Simple markdown to HTML conversion (basic implementation)
      let html = markdown
        // Headers
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        // Bold
        .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
        // Italic
        .replace(/_(.*?)_/gim, '<em>$1</em>')
        // Code
        .replace(/`(.*?)`/gim, '<code>$1</code>')
        // Links
        .replace(/\[(.*?)\]\((.*?)\)/gim, '<a href="$2">$1</a>')
        // Lists
        .replace(/^\- (.*$)/gim, '<li>$1</li>')
        .replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>')
        // Paragraphs
        .split('\n\n')
        .map(para => para.trim() && !para.startsWith('<') ? `<p>${para}</p>` : para)
        .join('\n');

      // Wrap lists
      html = html.replace(/(<li>.*<\/li>\n?)+/gim, match => {
        return markdown.includes('- ') ? `<ul>${match}</ul>` : `<ol>${match}</ol>`;
      });

      preview.innerHTML = html;
    }

    // Analyze impact of changes
    function analyzeImpact() {
      const impactContainer = document.getElementById('impactContent');

      // Mock impact analysis based on current section
      const impacts = {
        'overview': {
          risk: 'low',
          affected: [
            { sop: 'SOP-005: Comprehensive HR Onboarding', section: 'finance-setup', type: 'reference' }
          ]
        },
        'prerequisites': {
          risk: 'high',
          affected: [
            { sop: 'SOP-002: IT System Access', section: 'required-by', type: 'strong' },
            { sop: 'SOP-003: Security Training', section: 'required-by', type: 'strong' },
            { sop: 'SOP-005: HR Onboarding', section: 'prerequisites', type: 'medium' }
          ]
        },
        'procedure-steps': {
          risk: 'high',
          affected: [
            { sop: 'SOP-007: Expense Reimbursement', section: 'approval-process', type: 'strong' },
            { sop: 'SOP-005: HR Onboarding', section: 'finance-procedures', type: 'medium' }
          ]
        },
        'default': {
          risk: 'low',
          affected: []
        }
      };

      const impact = impacts[currentEditSection] || impacts.default;

      let html = '';

      if (impact.affected.length === 0) {
        html = `
          <div class="impact-info">
            <div class="impact-title">‚úÖ Low Impact Change</div>
            <div class="impact-list">
              <p>No direct dependencies detected. This change is safe to make.</p>
            </div>
          </div>
        `;
      } else {
        const riskColor = impact.risk === 'high' ? 'danger' : impact.risk === 'medium' ? 'warning' : 'success';
        html = `
          <div class="impact-${impact.risk === 'high' ? 'warning' : 'info'}">
            <div class="impact-title">‚ö†Ô∏è ${impact.affected.length} SOPs will be affected</div>
            <div class="impact-list">
              ${impact.affected.map(item => `
                <div class="impact-item">
                  <span class="impact-sop">${item.sop} <span class="risk-badge risk-${impact.risk}">${impact.risk.toUpperCase()}</span></span>
                  <span class="impact-section">‚Üí Section: ${item.section}</span>
                </div>
              `).join('')}
            </div>
          </div>

          <div class="impact-info" style="margin-top: 16px;">
            <div class="impact-title">üìã Recommended Actions</div>
            <div class="impact-list">
              <p>‚Ä¢ Review dependent SOPs after saving<br>
              ‚Ä¢ Notify owners of affected SOPs<br>
              ‚Ä¢ Run validation tests<br>
              ‚Ä¢ Update related documentation</p>
            </div>
          </div>
        `;
      }

      impactContainer.innerHTML = html;
    }

    // Editor input handler
    document.getElementById('markdownEditor')?.addEventListener('input', function() {
      isDirty = true;
      updateAutosaveIndicator('saving');
      updatePreview();

      // Debounce autosave
      clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(() => {
        autosave();
      }, 2000);
    });

    // Autosave function
    function autosave() {
      // In production, this would save to backend
      console.log('Autosaving changes...');
      updateAutosaveIndicator('saved');
      isDirty = false;
    }

    // Update autosave indicator
    function updateAutosaveIndicator(status) {
      const indicator = document.getElementById('autosaveIndicator');
      const text = document.getElementById('autosaveText');

      indicator.className = 'autosave-indicator';

      if (status === 'saving') {
        indicator.classList.add('saving');
        text.textContent = 'Saving...';
      } else if (status === 'saved') {
        indicator.classList.add('saved');
        text.textContent = 'All changes saved';
      }
    }

    // Insert markdown formatting
    function insertMarkdown(before, after) {
      const editor = document.getElementById('markdownEditor');
      const start = editor.selectionStart;
      const end = editor.selectionEnd;
      const selectedText = editor.value.substring(start, end);
      const replacement = before + selectedText + after;

      editor.value = editor.value.substring(0, start) + replacement + editor.value.substring(end);

      // Set cursor position
      const newCursorPos = start + before.length + selectedText.length;
      editor.setSelectionRange(newCursorPos, newCursorPos);
      editor.focus();

      // Trigger update
      editor.dispatchEvent(new Event('input'));
    }

    // Save edit
    function saveEdit() {
      const content = document.getElementById('markdownEditor').value;

      // In production, this would:
      // 1. Save to backend
      // 2. Update graph database
      // 3. Trigger dependency updates
      // 4. Create version history entry
      // 5. Notify affected SOP owners

      console.log('Saving section:', currentEditSection);
      console.log('New content:', content);

      // Update the section content in memory
      sectionContent[currentEditSection] = content;

      // Show success message
      alert(`‚úÖ Changes saved successfully!\n\n‚Ä¢ Section "${formatSectionName(currentEditSection)}" updated\n‚Ä¢ ${document.getElementById('impactContent').textContent.includes('0 SOPs') ? 'No' : 'Affected'} SOPs will be notified\n‚Ä¢ Version history updated`);

      // Close modal
      closeEditModal();

      // In production, reload the page content to show changes
      // location.reload();
    }

    // Cancel edit
    function cancelEdit() {
      if (isDirty) {
        if (!confirm('You have unsaved changes. Are you sure you want to cancel?')) {
          return;
        }
      }

      closeEditModal();
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      currentEditSection = null;
      isDirty = false;
      clearTimeout(autosaveTimer);
    }

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.getElementById('editModal').classList.contains('active')) {
        cancelEdit();
      }
    });

    // Show dependencies
    function showDependencies() {
      window.location.href = '/public/sop-dependencies.html';
    }

    // Version History State
    let selectedVersionId = null;
    let currentDiffMode = 'side-by-side';

    // Mock version history database
    const versionHistory = [
      {
        id: 'v1.2.0',
        version: 'v1.2.0',
        date: '2025-11-01',
        author: 'Sarah Chen (Finance Manager)',
        summary: 'Updated approval thresholds and added expense category validation',
        changes: '+12 lines, -8 lines',
        isCurrent: true,
        content: {
          'procedure-steps': `### Step 3: Approval Routing
1. Route to department manager for approval
2. Route to Finance Controller if >$10,000 (updated from $5,000)
3. Route to CFO if >$50,000
4. Track approval status in workflow system
5. Validate expense categories against approved list`
        }
      },
      {
        id: 'v1.1.0',
        version: 'v1.1.0',
        date: '2025-08-15',
        author: 'Mike Johnson (IT Operations)',
        summary: 'Added three-way match requirement and automated validation',
        changes: '+18 lines, -3 lines',
        isCurrent: false,
        content: {
          'procedure-steps': `### Step 3: Approval Routing
1. Route to department manager for approval
2. Route to Finance Controller if >$5,000
3. Route to CFO if >$50,000
4. Track approval status in workflow system`
        }
      },
      {
        id: 'v1.0.0',
        version: 'v1.0.0',
        date: '2024-01-15',
        author: 'Alice Smith (Process Owner)',
        summary: 'Initial SOP documentation - baseline invoice processing workflow',
        changes: 'Initial version',
        isCurrent: false,
        content: {
          'procedure-steps': `### Step 3: Approval Routing
1. Route to department manager for approval
2. Route to Finance if >$5,000
3. Track approval status manually`
        }
      }
    ];

    // Show version history
    function showVersionHistory() {
      // Render version list
      renderVersionList();

      // Show modal
      document.getElementById('versionModal').classList.add('active');

      // Select current version by default
      selectVersion('v1.2.0');
    }

    // Render version list
    function renderVersionList() {
      const container = document.getElementById('versionList');

      container.innerHTML = versionHistory.map(v => `
        <div class="version-item ${v.id === selectedVersionId ? 'active' : ''}"
             onclick="selectVersion('${v.id}')">
          <div class="version-number">
            ${v.version}
            ${v.isCurrent ? '<span class="current-badge">CURRENT</span>' : ''}
          </div>
          <div class="version-date">${v.date}</div>
          <div class="version-author">üë§ ${v.author}</div>
          <div class="version-changes">üìä ${v.changes}</div>
        </div>
      `).join('');
    }

    // Select version and show diff
    function selectVersion(versionId) {
      selectedVersionId = versionId;

      // Update active state in list
      renderVersionList();

      // Get version data
      const version = versionHistory.find(v => v.id === versionId);
      const previousVersionIndex = versionHistory.findIndex(v => v.id === versionId) + 1;
      const previousVersion = previousVersionIndex < versionHistory.length
        ? versionHistory[previousVersionIndex]
        : null;

      // Update metadata
      document.getElementById('selectedVersion').textContent = version.version;
      document.getElementById('versionAuthor').textContent = version.author;
      document.getElementById('versionDate').textContent = version.date;
      document.getElementById('versionSummary').textContent = version.summary;

      // Enable/disable restore button
      const restoreBtn = document.getElementById('restoreBtn');
      if (version.isCurrent) {
        restoreBtn.disabled = true;
        restoreBtn.style.opacity = '0.5';
        restoreBtn.style.cursor = 'not-allowed';
      } else {
        restoreBtn.disabled = false;
        restoreBtn.style.opacity = '1';
        restoreBtn.style.cursor = 'pointer';
      }

      // Generate diff
      if (previousVersion) {
        showDiff(version, previousVersion);
      } else {
        // First version - show content only
        showFirstVersion(version);
      }
    }

    // Show diff between versions
    function showDiff(newVersion, oldVersion) {
      const diffViewer = document.getElementById('diffViewer');

      // For simplicity, showing mock diff for one section
      const newContent = newVersion.content['procedure-steps'];
      const oldContent = oldVersion.content['procedure-steps'];

      // Simple line-by-line diff (in production, use a proper diff library)
      const newLines = newContent.split('\n');
      const oldLines = oldContent.split('\n');

      if (currentDiffMode === 'side-by-side') {
        diffViewer.innerHTML = `
          <div class="diff-view side-by-side">
            <div class="diff-column">
              <div class="diff-column-header">${oldVersion.version} (Previous)</div>
              ${renderDiffColumn(oldLines, 'old')}
            </div>
            <div class="diff-column">
              <div class="diff-column-header">${newVersion.version} (Selected)</div>
              ${renderDiffColumn(newLines, 'new')}
            </div>
          </div>
        `;
      } else {
        // Unified diff
        diffViewer.innerHTML = `
          <div class="diff-view unified">
            <div class="diff-section-header">Section: Procedure Steps - Approval Routing</div>
            ${renderUnifiedDiff(oldLines, newLines)}
          </div>
        `;
      }
    }

    // Render diff column for side-by-side view
    function renderDiffColumn(lines, type) {
      // Mock diff highlighting (in production, use proper diff algorithm)
      const highlightedLines = lines.map((line, idx) => {
        let className = 'unchanged';

        // Simple heuristic: if line contains "updated", "$10,000", or "Validate", it's changed
        if (type === 'new' && (line.includes('$10,000') || line.includes('updated') || line.includes('Validate'))) {
          className = 'added';
        } else if (type === 'old' && line.includes('$5,000') && !line.includes('if >$5,000')) {
          className = 'removed';
        }

        return `
          <div class="diff-line ${className}">
            <span class="diff-line-number">${idx + 1}</span>
            ${escapeHtml(line)}
          </div>
        `;
      });

      return highlightedLines.join('');
    }

    // Render unified diff
    function renderUnifiedDiff(oldLines, newLines) {
      // Mock unified diff (showing both removed and added lines)
      let html = '';

      oldLines.forEach((line, idx) => {
        const newLine = newLines[idx];

        if (line !== newLine) {
          if (line) {
            html += `
              <div class="diff-line removed">
                <span class="diff-line-number">-${idx + 1}</span>
                ${escapeHtml(line)}
              </div>
            `;
          }
          if (newLine) {
            html += `
              <div class="diff-line added">
                <span class="diff-line-number">+${idx + 1}</span>
                ${escapeHtml(newLine)}
              </div>
            `;
          }
        } else if (line) {
          html += `
            <div class="diff-line unchanged">
              <span class="diff-line-number">${idx + 1}</span>
              ${escapeHtml(line)}
            </div>
          `;
        }
      });

      // Add any new lines that don't have old counterparts
      for (let i = oldLines.length; i < newLines.length; i++) {
        html += `
          <div class="diff-line added">
            <span class="diff-line-number">+${i + 1}</span>
            ${escapeHtml(newLines[i])}
          </div>
        `;
      }

      return html;
    }

    // Show first version (no previous version to compare)
    function showFirstVersion(version) {
      const diffViewer = document.getElementById('diffViewer');
      const content = version.content['procedure-steps'];

      diffViewer.innerHTML = `
        <div class="impact-info">
          <div class="impact-title">üìÑ Initial Version</div>
          <div class="impact-list">
            <p>This is the first version of this SOP. No previous version to compare.</p>
          </div>
        </div>
        <div class="diff-view unified">
          <div class="diff-section-header">Section: Procedure Steps - Approval Routing</div>
          ${content.split('\n').map((line, idx) => `
            <div class="diff-line added">
              <span class="diff-line-number">${idx + 1}</span>
              ${escapeHtml(line)}
            </div>
          `).join('')}
        </div>
      `;
    }

    // Change diff mode
    function changeDiffMode(mode) {
      currentDiffMode = mode;

      // Update active button
      document.querySelectorAll('.diff-mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

      // Re-render diff with new mode
      if (selectedVersionId) {
        selectVersion(selectedVersionId);
      }
    }

    // Restore version
    function restoreVersion() {
      const version = versionHistory.find(v => v.id === selectedVersionId);

      if (confirm(`Restore ${version.version}?\n\nThis will:\n‚Ä¢ Create a new version (v1.3.0) based on ${version.version}\n‚Ä¢ Preserve current version in history\n‚Ä¢ Notify all stakeholders\n‚Ä¢ Update dependencies\n\nAre you sure?`)) {
        alert(`‚úÖ Version ${version.version} restored!\n\nNew version v1.3.0 created.\nAll dependent SOPs have been notified.`);
        closeVersionModal();

        // In production, would reload with new version
        // location.reload();
      }
    }

    // Close version modal
    function closeVersionModal() {
      document.getElementById('versionModal').classList.remove('active');
      selectedVersionId = null;
    }

    // Escape HTML for safe display
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Close version modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.getElementById('versionModal').classList.contains('active')) {
        closeVersionModal();
      }
    });

    // Show comments
    function showComments() {
      alert('Comments panel would slide in showing:\n\n‚Ä¢ 5 comments from users\n‚Ä¢ Inline comment threads\n‚Ä¢ Ability to add new comments\n‚Ä¢ @mentions for collaboration');
    }

    // Show more actions
    function showMoreActions() {
      alert('More actions:\n\n‚Ä¢ Clone as Template\n‚Ä¢ Archive SOP\n‚Ä¢ Export to different formats\n‚Ä¢ View Analytics\n‚Ä¢ Assign Reviewers');
    }

    // Download PDF
    function downloadPDF() {
      alert('Generating PDF...\n\nWould create formatted PDF with:\n‚Ä¢ Table of contents\n‚Ä¢ Page numbers\n‚Ä¢ Header/footer\n‚Ä¢ Proper formatting');
    }

    // Share SOP
    function shareSOP() {
      alert('Share options:\n\n‚Ä¢ Copy link\n‚Ä¢ Email to colleagues\n‚Ä¢ Generate public link\n‚Ä¢ Add to team workspace');
    }

    // Print SOP
    function printSOP() {
      window.print();
    }
  </script>
</body>
</html>
